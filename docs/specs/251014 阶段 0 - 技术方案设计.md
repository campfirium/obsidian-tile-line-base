# é˜¶æ®µ 0 - æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

**åˆ›å»ºæ—¥æœŸï¼š** 2025-10-14
**çŠ¶æ€ï¼š** å®Œæˆ

---

## ä¸€ã€TanStack Table v8 æ ¸å¿ƒ API ç ”ç©¶

### 1.1 æ ¸å¿ƒæ¦‚å¿µ

TanStack Table æ˜¯ä¸€ä¸ª **Headless UI åº“**ï¼š
- åªæä¾›é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
- ä¸æä¾›ä»»ä½• UI ç»„ä»¶
- å¼€å‘è€…å®Œå…¨æ§åˆ¶æ¸²æŸ“

### 1.2 æ ¸å¿ƒ API

```typescript
import { useReactTable, getCoreRowModel, flexRender } from '@tanstack/react-table'

// åˆ›å»º table å®ä¾‹
const table = useReactTable({
  data,              // æ•°æ®æ•°ç»„
  columns,           // åˆ—å®šä¹‰æ•°ç»„
  getCoreRowModel: getCoreRowModel(),  // æ ¸å¿ƒè¡Œæ¨¡å‹
  // ... å…¶ä»–é…ç½®
})

// ä¸»è¦æ–¹æ³•
table.getHeaderGroups()     // è·å–è¡¨å¤´
table.getRowModel().rows    // è·å–è¡Œæ•°æ®
table.getState()            // è·å–å½“å‰çŠ¶æ€
table.setState()            // æ›´æ–°çŠ¶æ€
```

### 1.3 åˆ—å®šä¹‰ (ColumnDef)

```typescript
const columns: ColumnDef<RowData>[] = [
  {
    id: 'columnId',              // å”¯ä¸€æ ‡è¯†
    accessorKey: 'fieldName',    // æ•°æ®å­—æ®µå
    header: 'Header Text',       // è¡¨å¤´
    cell: (props) => {           // è‡ªå®šä¹‰å•å…ƒæ ¼æ¸²æŸ“
      return <span>{props.getValue()}</span>
    },
    size: 200,                   // åˆ—å®½
    enableSorting: true,         // å¯ç”¨æ’åº
    // ... å…¶ä»–é…ç½®
  }
]
```

### 1.4 çŠ¶æ€ç®¡ç†

```typescript
// æ‰€æœ‰çŠ¶æ€éƒ½æ˜¯æ˜¾å¼çš„
const [data, setData] = useState([])
const [sorting, setSorting] = useState([])
const [rowSelection, setRowSelection] = useState({})
const [columnVisibility, setColumnVisibility] = useState({})

const table = useReactTable({
  data,
  columns,
  state: {
    sorting,
    rowSelection,
    columnVisibility,
  },
  onSortingChange: setSorting,
  onRowSelectionChange: setRowSelection,
  // ...
})
```

### 1.5 æ¸²æŸ“æ¨¡å¼

```tsx
// è¡¨å¤´æ¸²æŸ“
{table.getHeaderGroups().map(headerGroup => (
  <tr key={headerGroup.id}>
    {headerGroup.headers.map(header => (
      <th key={header.id}>
        {flexRender(header.column.columnDef.header, header.getContext())}
      </th>
    ))}
  </tr>
))}

// æ•°æ®è¡Œæ¸²æŸ“
{table.getRowModel().rows.map(row => (
  <tr key={row.id}>
    {row.getVisibleCells().map(cell => (
      <td key={cell.id}>
        {flexRender(cell.column.columnDef.cell, cell.getContext())}
      </td>
    ))}
  </tr>
))}
```

---

## äºŒã€AgGridAdapter åŠŸèƒ½ç‚¹åˆ†æ

### 2.1 æ ¸å¿ƒåŠŸèƒ½æ¸…å•

ä» `src/grid/AgGridAdapter.ts` åˆ†æå¾—å‡ºï¼š

| åŠŸèƒ½ | AgGridAdapter å®ç° | ä¼˜å…ˆçº§ |
|------|-------------------|--------|
| **åŸºç¡€æ¸²æŸ“** | âœ… mount() | ğŸ”¥ğŸ”¥ğŸ”¥ |
| **æ•°æ®æ›´æ–°** | âœ… updateData() | ğŸ”¥ğŸ”¥ğŸ”¥ |
| **é”€æ¯æ¸…ç†** | âœ… destroy() | ğŸ”¥ğŸ”¥ğŸ”¥ |
| **å•å…ƒæ ¼ç¼–è¾‘** | âœ… onCellEdit() | ğŸ”¥ğŸ”¥ğŸ”¥ |
| **è¡Œé€‰æ‹©** | âœ… getSelectedRows(), selectRow() | ğŸ”¥ğŸ”¥ |
| **Status åˆ—** | âœ… è‡ªå®šä¹‰æ¸²æŸ“ + äº¤äº’ | ğŸ”¥ğŸ”¥ |
| **é”®ç›˜å¯¼èˆª** | âœ… Enter/Tab/æ–¹å‘é”® | ğŸ”¥ğŸ”¥ |
| **å¤åˆ¶ç²˜è´´** | âœ… Ctrl+C / Ctrl+V | ğŸ”¥ |
| **æ’åºç­›é€‰** | âœ… å†…ç½®åŠŸèƒ½ | ğŸ”¥ |
| **åˆ—å®½è°ƒæ•´** | âœ… è‡ªåŠ¨è°ƒæ•´ + æ‰‹åŠ¨æ‹–æ‹½ | ğŸ”¥ |
| **è™šæ‹Ÿæ»šåŠ¨** | âœ… å†…ç½®æ€§èƒ½ä¼˜åŒ– | ğŸ”¥ |
| **çª—å£è°ƒæ•´** | âœ… resizeColumns() | ğŸ”¥ |
| **æœ€åä¸€è¡Œ Enter** | âœ… onEnterAtLastRow() | ğŸ”¥ |

### 2.2 GridAdapter æ¥å£å®šä¹‰

ä» `src/grid/GridAdapter.ts` åˆ†æï¼š

```typescript
export interface GridAdapter {
  // æ ¸å¿ƒæ–¹æ³•ï¼ˆå¿…éœ€ï¼‰
  mount(container: HTMLElement, columns: ColumnDef[], rows: RowData[], context?: any): void;
  updateData(rows: RowData[]): void;
  destroy(): void;
  onCellEdit(callback: (event: CellEditEvent) => void): void;
  onHeaderEdit(callback: (event: HeaderEditEvent) => void): void;
  getSelectedRows(): number[];
  getRowIndexFromEvent(event: MouseEvent): number | null;

  // å¯é€‰æ–¹æ³•
  resizeColumns?(): void;
  markLayoutDirty?(): void;
  selectRow?(blockIndex: number, options?: { ensureVisible?: boolean }): void;
  startEditingFocusedCell?(): void;
  getFocusedCell?(): { rowIndex: number; field: string } | null;
  onEnterAtLastRow?(callback: (field: string) => void): void;
}
```

---

## ä¸‰ã€TanStackAdapter æ˜ å°„æ–¹æ¡ˆ

### 3.1 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          TableView (ä¸šåŠ¡å±‚)              â”‚
â”‚  - è°ƒç”¨ GridAdapter æ¥å£                 â”‚
â”‚  - ä¸å…³å¿ƒåº•å±‚å®ç°                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       GridAdapter (æŠ½è±¡æ¥å£)             â”‚
â”‚  - å®šä¹‰ç»Ÿä¸€çš„è¡¨æ ¼æ“ä½œæ¥å£                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      TanStackAdapter (å®ç°å±‚)            â”‚
â”‚  - ä½¿ç”¨ TanStack Table å®ç°æ¥å£          â”‚
â”‚  - ç®¡ç† React çŠ¶æ€                       â”‚
â”‚  - æ¸²æŸ“ DOM                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    TanStack Table (æ ¸å¿ƒé€»è¾‘å±‚)           â”‚
â”‚  - æä¾›è¡¨æ ¼é€»è¾‘                          â”‚
â”‚  - çŠ¶æ€ç®¡ç†                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæŠ€æœ¯æŒ‘æˆ˜

#### æŒ‘æˆ˜ 1ï¼šé React ç¯å¢ƒä¸­ä½¿ç”¨ React Hooks

**é—®é¢˜ï¼š** TanStack Table ä½¿ç”¨ `useReactTable` hookï¼Œä½† Obsidian æ’ä»¶ä¸æ˜¯æ ‡å‡† React åº”ç”¨ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
import { createRoot, Root } from 'react-dom/client';
import { createElement } from 'react';

class TanStackAdapter implements GridAdapter {
  private root: Root | null = null;
  private containerEl: HTMLElement | null = null;

  mount(container: HTMLElement, columns: ColumnDef[], rows: RowData[]) {
    // åˆ›å»º React æ ¹èŠ‚ç‚¹
    this.root = createRoot(container);
    this.containerEl = container;

    // æ¸²æŸ“ React ç»„ä»¶
    this.root.render(
      createElement(TableComponent, {
        columns,
        rows,
        adapter: this
      })
    );
  }

  destroy() {
    if (this.root) {
      this.root.unmount();
      this.root = null;
    }
  }
}
```

#### æŒ‘æˆ˜ 2ï¼šçŠ¶æ€ç®¡ç†å’Œäº‹ä»¶å›è°ƒ

**é—®é¢˜ï¼š** éœ€è¦åœ¨ React ç»„ä»¶å†…éƒ¨ç®¡ç†çŠ¶æ€ï¼ŒåŒæ—¶å‘å¤–éƒ¨æš´éœ²å›è°ƒæ¥å£ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// ä½¿ç”¨ ref å­˜å‚¨å›è°ƒå‡½æ•°
class TanStackAdapter implements GridAdapter {
  private cellEditCallback?: (event: CellEditEvent) => void;
  private enterAtLastRowCallback?: (field: string) => void;

  onCellEdit(callback: (event: CellEditEvent) => void) {
    this.cellEditCallback = callback;
  }

  onEnterAtLastRow(callback: (field: string) => void) {
    this.enterAtLastRowCallback = callback;
  }

  // åœ¨ React ç»„ä»¶ä¸­é€šè¿‡ props ä¼ é€’ adapter
  // ç»„ä»¶å†…éƒ¨å¯ä»¥è°ƒç”¨ adapter.cellEditCallback?.()
}
```

#### æŒ‘æˆ˜ 3ï¼šæ•°æ®æ›´æ–°

**é—®é¢˜ï¼š** updateData() è¢«å¤–éƒ¨è°ƒç”¨ï¼Œéœ€è¦è§¦å‘ React ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// æ–¹æ¡ˆ Aï¼šä½¿ç”¨å¤–éƒ¨çŠ¶æ€ç®¡ç†ï¼ˆæ¨èï¼‰
class TanStackAdapter implements GridAdapter {
  private updateDataFn?: (rows: RowData[]) => void;

  mount(container, columns, rows) {
    this.root.render(
      createElement(TableComponent, {
        initialRows: rows,
        onMount: (updateFn) => {
          this.updateDataFn = updateFn;
        }
      })
    );
  }

  updateData(rows: RowData[]) {
    this.updateDataFn?.(rows);
  }
}

// TableComponent å†…éƒ¨
function TableComponent({ initialRows, onMount }) {
  const [data, setData] = useState(initialRows);

  useEffect(() => {
    onMount(setData);  // æš´éœ² setData ç»™å¤–éƒ¨
  }, []);

  // ...
}
```

---

## å››ã€æ¸è¿›å¼å®æ–½è®¡åˆ’

### 4.1 é˜¶æ®µ 1 æœ€å°å¯ç”¨ç‰ˆæœ¬ (MVP)

**ç›®æ ‡ï¼š** å®ç°æœ€åŸºç¡€çš„æ¸²æŸ“å’Œæ•°æ®æ›´æ–°

```typescript
// æœ€ç®€å•çš„ TableComponent
function TableComponent({ data, columns }) {
  const table = useReactTable({
    data,
    columns,
    getCoreRowModel: getCoreRowModel(),
  });

  return (
    <table>
      <thead>
        {table.getHeaderGroups().map(headerGroup => (
          <tr key={headerGroup.id}>
            {headerGroup.headers.map(header => (
              <th key={header.id}>
                {flexRender(header.column.columnDef.header, header.getContext())}
              </th>
            ))}
          </tr>
        ))}
      </thead>
      <tbody>
        {table.getRowModel().rows.map(row => (
          <tr key={row.id}>
            {row.getVisibleCells().map(cell => (
              <td key={cell.id}>
                {flexRender(cell.column.columnDef.cell, cell.getContext())}
              </td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>
  );
}
```

**éªŒæ”¶æ ‡å‡†ï¼š**
- âœ… èƒ½å¤Ÿæ˜¾ç¤ºè¡¨æ ¼
- âœ… èƒ½å¤Ÿæ›´æ–°æ•°æ®
- âœ… åºå·åˆ—æ­£å¸¸æ˜¾ç¤º

### 4.2 åŠŸèƒ½æ˜ å°„è¡¨

| GridAdapter æ¥å£ | TanStack Table å®ç° | éš¾åº¦ |
|------------------|-------------------|------|
| `mount()` | createRoot + render | â­ |
| `updateData()` | setState | â­ |
| `destroy()` | root.unmount() | â­ |
| `onCellEdit()` | è‡ªå®šä¹‰ cell + onBlur | â­â­ |
| `getSelectedRows()` | table.getState().rowSelection | â­â­ |
| `selectRow()` | row.toggleSelected() | â­â­ |
| `getFocusedCell()` | è‡ªå·±ç®¡ç† focus çŠ¶æ€ | â­â­ |
| `startEditingFocusedCell()` | è‡ªå·±ç®¡ç†ç¼–è¾‘çŠ¶æ€ | â­â­ |
| `onEnterAtLastRow()` | è‡ªå®šä¹‰é”®ç›˜äº‹ä»¶ | â­â­ |
| `resizeColumns()` | è‡ªå·±å®ç°å¸ƒå±€è°ƒæ•´ | â­â­â­ |
| `markLayoutDirty()` | å¼ºåˆ¶é‡æ–°æ¸²æŸ“ | â­ |

---

## äº”ã€æŠ€æœ¯æ ˆç¡®å®š

### 5.1 æ ¸å¿ƒä¾èµ–

```json
{
  "dependencies": {
    "@tanstack/react-table": "^8.11.0",
    "@tanstack/react-virtual": "^3.0.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0"
  }
}
```

### 5.2 æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ grid/
â”‚   â”œâ”€â”€ GridAdapter.ts              (å·²å­˜åœ¨ï¼Œæ¥å£å®šä¹‰)
â”‚   â”œâ”€â”€ AgGridAdapter.ts            (å·²å­˜åœ¨ï¼Œå¾…åˆ é™¤)
â”‚   â”œâ”€â”€ TanStackAdapter.ts          (æ–°å»ºï¼Œé€‚é…å™¨å®ç°)
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ TableComponent.tsx      (æ–°å»ºï¼Œä¸»è¡¨æ ¼ç»„ä»¶)
â”‚       â”œâ”€â”€ EditableCell.tsx        (æ–°å»ºï¼Œå¯ç¼–è¾‘å•å…ƒæ ¼)
â”‚       â”œâ”€â”€ StatusCell.tsx          (æ–°å»ºï¼ŒçŠ¶æ€åˆ—)
â”‚       â””â”€â”€ TableStyles.css         (æ–°å»ºï¼Œæ ·å¼)
```

---

## å…­ã€å¼€å‘çº¦å®š

### 6.1 å‘½åè§„èŒƒ

- React ç»„ä»¶ï¼šPascalCase (TableComponent.tsx)
- é€‚é…å™¨ç±»ï¼šPascalCase (TanStackAdapter)
- æ ·å¼æ–‡ä»¶ï¼škebab-case (table-styles.css)
- CSS ç±»åï¼škebab-case (tlb-table, tlb-cell)

### 6.2 ä»£ç é£æ ¼

```typescript
// âœ… å¥½çš„å®è·µ
function EditableCell({ value, onSave }) {
  const [editing, setEditing] = useState(false);
  const [tempValue, setTempValue] = useState(value);

  // æ¸…æ™°çš„å‡½æ•°å
  const handleStartEdit = () => setEditing(true);
  const handleSave = () => {
    onSave(tempValue);
    setEditing(false);
  };

  return editing ? <input /> : <span />;
}

// âŒ é¿å…
function Cell(p) {  // ä¸æ¸…æ™°çš„å‚æ•°å
  const [e, setE] = useState(false);  // ä¸æ¸…æ™°çš„å˜é‡å
  // ...
}
```

### 6.3 TypeScript ç±»å‹

```typescript
// å……åˆ†åˆ©ç”¨ TanStack Table çš„ç±»å‹ç³»ç»Ÿ
import { ColumnDef, Table, Row, Cell } from '@tanstack/react-table';

// è‡ªå®šä¹‰ç±»å‹
interface TableComponentProps {
  columns: ColumnDef<RowData>[];
  data: RowData[];
  adapter: TanStackAdapter;
}

// ä½¿ç”¨æ³›å‹
function EditableCell<T>({ cell }: { cell: Cell<T, unknown> }) {
  // ...
}
```

---

## ä¸ƒã€é£é™©è¯„ä¼°

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹ |
|------|------|------|------|
| React é›†æˆé—®é¢˜ | é«˜ | ä¸­ | æå‰éªŒè¯ createRoot å¯è¡Œæ€§ |
| æ€§èƒ½ä¸å¦‚ AG Grid | ä¸­ | ä½ | æ—©æœŸå¼•å…¥è™šæ‹Ÿæ»šåŠ¨ |
| æ ·å¼é€‚é…å›°éš¾ | ä¸­ | ä½ | ä½¿ç”¨ CSS Variables |
| åŠŸèƒ½é—æ¼ | é«˜ | ä¸­ | è¯¦ç»†çš„åŠŸèƒ½å¯¹ç…§è¡¨ |
| å¼€å‘æ—¶é—´è¶…æœŸ | ä¸­ | ä¸­ | åˆ†é˜¶æ®µéªŒæ”¶ï¼Œä¼˜å…ˆæ ¸å¿ƒåŠŸèƒ½ |

---

## å…«ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### 8.1 ç«‹å³è¡ŒåŠ¨ï¼ˆé˜¶æ®µ 1ï¼‰

1. âœ… å®‰è£…ä¾èµ–åŒ…
2. âœ… åˆ›å»ºæ–‡ä»¶ç»“æ„
3. âœ… å®ç°æœ€ç®€å•çš„ TanStackAdapter
4. âœ… å®ç°æœ€ç®€å•çš„ TableComponent
5. âœ… åœ¨ TableView ä¸­åˆ‡æ¢åˆ° TanStackAdapter
6. âœ… éªŒè¯åŸºç¡€æ¸²æŸ“

### 8.2 éªŒè¯æ ‡å‡†

- [ ] èƒ½å¤Ÿæ˜¾ç¤ºè¡¨æ ¼ï¼ˆè¡¨å¤´ + æ•°æ®ï¼‰
- [ ] èƒ½å¤Ÿæ›´æ–°æ•°æ®ï¼ˆupdateData ç”Ÿæ•ˆï¼‰
- [ ] åºå·åˆ—æ­£å¸¸æ˜¾ç¤º
- [ ] æ ·å¼åŸºæœ¬é€‚é… Obsidian ä¸»é¢˜

---

**æ–‡æ¡£çŠ¶æ€ï¼š** âœ… å®Œæˆ
**ä¸‹ä¸€æ­¥ï¼š** å¼€å§‹é˜¶æ®µ 1 - å®ç°åŸºç¡€ TanStackAdapter
