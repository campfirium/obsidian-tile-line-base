好的，那我来帮你写一份**新的决策备忘录**，和之前的《切换到 TanStack Table》形成对照。

---

# 251016 技术决策：切回 AG Grid 社区版

**日期**：2025-10-16
**作者**：AI 协作日志
**上下文**：基于分支 `feat/switch-to-aggrid` 的决策复盘
**相关文档**：《251014 技术决策：切换到 TanStack Table》

---

## 1. 背景

在 251014 的决策文档中，我们从 AG Grid 社区版迁移到 TanStack Table，理由是：

* TanStack Table API 简洁、逻辑透明，适合 **AI 协作开发**。
* AG Grid 社区版功能残缺（缺少 RangeSelection、Clipboard、Pivot、Excel 导出），而企业版受制于付费墙。
* 目标是长期可控，避免黑盒化依赖。

然而，在实际推进后遇到了严重问题：

* TanStack **没有内建 cell selection**，连基础的“单元格高亮 + 焦点管理”都要自建交互内核。
* Excel 级交互（矩形框选、粘贴、拖拽填充、方向键导航）全部缺席。
* AI 生成的代码多次失败：事件冒泡冲突、CSS 样式未命中、焦点丢失，导致工期急剧上升。
* 简单 CRUD 也比 AG Grid 更难快速交付。

于是我们在 251016 决定**切回 AG Grid 社区版**。

---

## 2. 决策动因

### 2.1 TanStack Table 的问题

* **单元格选择缺失**：基础交互需要自行搭建“交互内核”。
* **工期成本高**：AI 不擅长造交互内核，自动生成反复失败，人工干预过多。
* **MVP 与战略错位**：我们的短期目标是“终极表格视图”能跑 CRUD，而不是 Excel 克隆。TanStack 把精力绑死在“造轮子”，忽视了 MVP 上岸。

### 2.2 AG Grid 社区版的现实优势

* **CRUD 极速落地**：行选中、分页、过滤、排序、编辑，都有现成功能。
* **AI 支持丰富**：AG Grid 的文档、示例、StackOverflow 资料比 TanStack 更成熟，AI 代码生成稳定。
* **Excel 级交互可以规避**：矩形框选、填充柄等“企业功能”在 MVP 阶段标记为“非目标”。用户仍能通过行多选 + 批量操作替代。
* **工期更短**：AG Grid 社区版不需要搭建底层交互内核，能把资源投到真正的护城河（解析/写回、缓存、视图保存）。

### 2.3 企业版付费墙的再评价

* **短期回避**：MVP 不追求 Excel 级交互，因此暂不购买。
* **中期策略**：若用户强烈需求，可以：

  * A/B 实现 → 用“重编辑模式”引入 Glide Data Grid / Tabulator；
  * 或评估 AG Grid 企业许可证。

---

## 3. 新的非目标清单

为避免“影子战”重演，这里明确排除：

* 不做 **矩形框选 / 拖拽填充 / 高级粘贴**。
* 不做 **动态自适应行高**（改为固定行高 + 明细展开/tooltip）。
* 不做 **完整撤销/重做（时间旅行级别）**，仅支持轻量编辑回退。
* 不做 **Excel 导出**（初期只支持 CSV）。

---

## 4. 执行路线

1. **行即原子架构 + H2 解析器**（内核护城河）。
2. **AG Grid 社区版挂壳** → CRUD + 状态列交互。
3. **基础快捷键 & 单格复制粘贴** → 优化交互动线。
4. **Debounce+Throttle 写回 + mtime 缓存** → 保证秒开与安全。
5. **过滤视图（保存视图）** → 提供生产力成果。
6. **非目标清单写入 README**，AI 生成代码时必须遵循。

---

## 5. 对比表（重写后的结论）

| 维度        | TanStack Table | AG Grid 社区版 | AG Grid 企业版 |
| --------- | -------------- | ----------- | ----------- |
| AI 协作     | 理论友好，实操失败率高    | **稳定，资料丰富** | 同社区版        |
| CRUD 落地速度 | 慢，需要自己接线       | **快，开箱即用**  | 快           |
| Excel 级交互 | 必须自建内核，工期爆炸    | 缺失（企业功能）    | **完整支持**    |
| 可控性       | 高，完全自定义        | 中，黑盒但稳定     | 低，锁付费       |
| 成本        | 0（但时间成本高）      | 0（功能有限）     | $$$         |

**结论**：对我们的 MVP 来说，AG Grid 社区版是最优选择。

---

## 6. 后续展望

* **Plan B**：为重度用户提供“重编辑模式”（Glide Data Grid/Tabulator）。
* **Plan C**：当且仅当用户强烈要求 Excel 级交互，再评估企业版。
* **战略聚焦**：把资源集中在“行即原子”、“镜像写回”、“智能缓存”、“跨视图索引”——这些才是 Foliole/Future 的独家护城河。

---

> **总结**
> 251014 的“切换到 TanStack”是出于 AI 协作友好性的理想判断，但实际落地发现工期爆炸，MVP 延误。251016 的决策回滚到 AG Grid 社区版，明确 Excel 功能为非目标，把工期投到真正的核心。后续若需求升级，可通过重编辑模式或企业版解决。

---

要不要我帮你把这篇和《251014 技术决策：切换到 TanStack Table》做一个**对照版表格**，直接放到文档尾部，让后来人一眼能看到两次决策的来龙去脉？
