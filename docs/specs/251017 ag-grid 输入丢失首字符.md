# 251017 ag-grid è¾“å…¥ä¸¢å¤±é¦–å­—ç¬¦

**æ›´æ–°æ—¥æœŸ**: 2025-10-17
**é—®é¢˜**: åœ¨ AG Grid ä¸­æŒ‰é”®å¯åŠ¨ç¼–è¾‘æ—¶ï¼Œé¦–å­—ç¬¦ä¸¢å¤±ï¼ˆä¾‹å¦‚è¾“å…¥ "123" åªæ˜¾ç¤º "23"ï¼‰
**ä¸¥é‡ç¨‹åº¦**: é«˜ - å½±å“æ ¸å¿ƒç¼–è¾‘ä½“éªŒ
**çŠ¶æ€**: è°ƒæŸ¥ä¸­

---

## é—®é¢˜ç°çŠ¶

### âš ï¸ é‡è¦æ¾„æ¸…ï¼šè¿™æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„é—®é¢˜ï¼

ç»è¿‡æ·±å…¥è°ƒè¯•ï¼Œç¡®è®¤è¿™æ˜¯**ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„é—®é¢˜**ï¼Œä¸æ˜¯åŒä¸€ä¸ªé—®é¢˜åœ¨ä¸åŒçª—å£çš„è¡¨ç°ï¼š

### é—®é¢˜ Aï¼šä¸»çª—å£ - é¦–å­—ç¬¦ä¸¢å¤± âœ… å·²è§£å†³
**ç—‡çŠ¶**:
- æŒ‰é”®å¯åŠ¨ç¼–è¾‘æ—¶é¦–å­—ç¬¦ä¸¢å¤±ï¼ˆä¾‹å¦‚æŒ‰ "123" åªæ˜¾ç¤º "23"ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
é€šè¿‡åˆ›å»ºè‡ªå®šä¹‰ TextCellEditorï¼Œæ•è· `eventKey` å‚æ•°å¹¶æ­£ç¡®å¤„ç†ï¼Œé—®é¢˜å·²è§£å†³ã€‚

**çŠ¶æ€**: âœ… **å·²è§£å†³** - ä¸»çª—å£ä¸­ç¼–è¾‘åŠŸèƒ½æ­£å¸¸

---

### é—®é¢˜ Bï¼šPop-out çª—å£ - è¡¨æ ¼è§†å›¾å®Œå…¨æ— æ³•æ¸²æŸ“
**ç—‡çŠ¶**:
- åœ¨ pop-out çª—å£ä¸­æ— æ³•ä½¿ç”¨è¡¨æ ¼è§†å›¾
- æ§åˆ¶å°**å®Œå…¨æ²¡æœ‰ä»»ä½•æ—¥å¿—**

**è°ƒè¯•çŠ¶æ€**:
- âŒ æ²¡æœ‰ "=== TableView.render å¼€å§‹ ===" æ—¥å¿—
- âŒ æ²¡æœ‰ "=== AG Grid åˆå§‹åŒ– ===" æ—¥å¿—
- âŒ æ²¡æœ‰ "=== TextCellEditor.init å¼€å§‹ ===" æ—¥å¿—
- âŒ **æ§åˆ¶å°å®Œå…¨é™é»˜**

**ç»“è®º**: æ•´ä¸ªè¡¨æ ¼è§†å›¾åœ¨ pop-out çª—å£ä¸­æ ¹æœ¬æ²¡æœ‰è¢«æ¸²æŸ“ï¼Œé—®é¢˜åœ¨ TableView çš„æ›´ä¸Šå±‚ï¼ˆè§†å›¾æ³¨å†Œæˆ–è·¯ç”±ï¼‰ã€‚

---

### æŠ€æœ¯ç¯å¢ƒ
- **AG Grid ç‰ˆæœ¬**: v34.2.0 Community
- **Obsidian ç‰ˆæœ¬**: æœ€æ–°ç‰ˆ
- **ç¼–è¾‘å™¨**: è‡ªå®šä¹‰ TextCellEditorï¼ˆå®ç° ICellEditorComp æ¥å£ï¼‰

---

## å·²å®Œæˆçš„æ’æŸ¥å’Œå°è¯•

### âœ… å°è¯• 1: åˆ›å»ºè‡ªå®šä¹‰ TextCellEditor

**ä»£ç ä½ç½®**: `src/grid/editors/TextCellEditor.ts`

**å®ç°æ€è·¯**:
```typescript
init(params: ICellEditorParams): void {
    // AG Grid 34+ ä½¿ç”¨ eventKey ä¼ é€’æŒ‰é”®
    const eventKey = (params as any).eventKey;

    if (eventKey && eventKey.length === 1) {
        // ä½¿ç”¨æŒ‰é”®ä½œä¸ºåˆå§‹å€¼
        this.eInput.value = eventKey;
    } else {
        // ä½¿ç”¨åŸæœ‰å€¼
        this.eInput.value = this.initialValue;
    }
}
```

**é…ç½®ä½ç½®**: `src/grid/AgGridAdapter.ts:180`
```typescript
defaultColDef: {
    cellEditor: TextCellEditor,
    // ...
}
```

**ç»“æœ**:
- âœ… ä¸»çª—å£: æœ‰æ—¥å¿—è¾“å‡ºï¼ŒTextCellEditor è¢«æ­£ç¡®è°ƒç”¨
- âŒ ä¸»çª—å£: é¦–å­—ç¬¦ä»ç„¶ä¸¢å¤±ï¼ˆå³ä½¿ eventKey æœ‰å€¼ï¼‰
- âŒ Pop-out çª—å£: å®Œå…¨æ— æ—¥å¿—ï¼Œç¼–è¾‘å™¨æœªè¢«è°ƒç”¨

---

### âœ… å°è¯• 2: ä¿®å¤æ‰€æœ‰ document context é—®é¢˜

**ç†è®ºä¾æ®**: Obsidian pop-out çª—å£æœ‰ç‹¬ç«‹çš„ Document å’Œ Window å¯¹è±¡

**ä¿®å¤æ¸…å•**:

1. **TextCellEditor.ts:19**
   ```typescript
   // ä¿®å¤å‰
   this.eInput = document.createElement('input');

   // ä¿®å¤å
   const doc = (params.eGridCell?.ownerDocument || document);
   this.eInput = doc.createElement('input');
   ```

2. **TableView.ts:494** - ä¸»é¢˜æ£€æµ‹
   ```typescript
   // ä¿®å¤å‰
   const isDarkMode = document.body.classList.contains('theme-dark');

   // ä¿®å¤å
   const ownerDoc = (container as HTMLElement).ownerDocument;
   const isDarkMode = ownerDoc.body.classList.contains('theme-dark');
   ```

3. **TableView.ts:887** - ç¼–è¾‘çŠ¶æ€æ£€æµ‹
   ```typescript
   // ä¿®å¤å‰
   const activeElement = document.activeElement;

   // ä¿®å¤å
   const ownerDoc = tableContainer.ownerDocument;
   const activeElement = ownerDoc.activeElement;
   ```

4. **StatusCellRenderer.ts:94**
   ```typescript
   // ä¿®å¤å‰
   this.eGui = document.createElement('div');

   // ä¿®å¤å
   const doc = (params.eGridCell?.ownerDocument || document);
   this.eGui = doc.createElement('div');
   ```

**ç»“æœ**:
- âŒ ä¸»çª—å£: é¦–å­—ç¬¦ä¸¢å¤±é—®é¢˜ä¾æ—§
- âŒ Pop-out çª—å£: ä»ç„¶æ— æ³•å·¥ä½œ

---

### âœ… å°è¯• 3: é…ç½® AG Grid popupParent

**ç†è®ºä¾æ®**:
- AG Grid ä½¿ç”¨ `popupParent` é€‰é¡¹æ§åˆ¶å¼¹å‡ºå…ƒç´ ï¼ˆç¼–è¾‘å™¨ã€èœå•ï¼‰çš„çˆ¶å®¹å™¨
- åœ¨å¤šçª—å£ç¯å¢ƒä¸­ï¼Œéœ€è¦æ˜¾å¼æŒ‡å®šæ­£ç¡®çš„ document.body

**ä»£ç ä½ç½®**: `src/grid/AgGridAdapter.ts:145-163`

**å®ç°**:
```typescript
// è·å–å®¹å™¨æ‰€åœ¨çš„ document å’Œ bodyï¼ˆæ”¯æŒ pop-out çª—å£ï¼‰
const ownerDoc = container.ownerDocument;
const popupParent = ownerDoc.body;

const gridOptions: GridOptions = {
    columnDefs: colDefs,
    rowData: rows,
    // ...
    popupParent: popupParent,  // ğŸ”‘ å…³é”®é…ç½®
    // ...
};
```

**ç»“æœ**:
- âŒ ä¸»çª—å£: é¦–å­—ç¬¦ä¸¢å¤±é—®é¢˜ä¾æ—§
- âŒ Pop-out çª—å£: ä»ç„¶æ— æ³•å·¥ä½œ

---

### âœ… å°è¯• 4: æ·»åŠ å…¨é¢çš„è°ƒè¯•æ—¥å¿—

**ç›®çš„**: ç¡®å®šé—®é¢˜å‘ç”Ÿåœ¨å“ªä¸ªé˜¶æ®µ

**æ·»åŠ çš„æ—¥å¿—**:

1. **TableView.ts:436** - render æ–¹æ³•å¼€å§‹
   ```typescript
   console.log('=== TableView.render å¼€å§‹ ===');
   console.log('container.ownerDocument === document:', ...);
   ```

2. **AgGridAdapter.ts:150** - AG Grid åˆå§‹åŒ–
   ```typescript
   console.log('=== AG Grid åˆå§‹åŒ– ===');
   console.log('ownerDoc === document:', ...);
   ```

3. **TextCellEditor.ts:35** - ç¼–è¾‘å™¨åˆå§‹åŒ–
   ```typescript
   console.log('=== TextCellEditor.init å¼€å§‹ ===');
   console.log('Full params:', params);
   console.log('eventKey:', eventKey);
   ```

**æµ‹è¯•ç»“æœ**:

ä¸»çª—å£ï¼š
- âœ… æ‰€æœ‰æ—¥å¿—éƒ½æ­£å¸¸è¾“å‡º
- âœ… eventKey æœ‰æ­£ç¡®çš„å€¼
- âŒ ä½†é¦–å­—ç¬¦ä»ç„¶ä¸¢å¤±

Pop-out çª—å£ï¼š
- âŒ **æ§åˆ¶å°å®Œå…¨é™é»˜ï¼Œæ²¡æœ‰ä»»ä½•æ—¥å¿—**
- âŒ è¿ TableView.render çš„æ—¥å¿—éƒ½æ²¡æœ‰

**é‡è¦å‘ç°**:
- é—®é¢˜ Aï¼ˆé¦–å­—ç¬¦ä¸¢å¤±ï¼‰ä¸ Obsidian pop-out çª—å£æ— å…³ï¼Œæ˜¯çº¯ AG Grid çš„é—®é¢˜
- é—®é¢˜ Bï¼ˆpop-out çª—å£æ— æ³•æ¸²æŸ“ï¼‰æ˜¯æ›´ä¸Šå±‚çš„ Obsidian è§†å›¾ç®¡ç†é—®é¢˜

---

## æœç´¢å‘ç°çš„å…³é”®ä¿¡æ¯

### Obsidian å®˜æ–¹æ–‡æ¡£
**æ¥æº**: https://obsidian.md/blog/how-to-update-plugins-to-support-pop-out-windows/

**å…³é”®å‘ç°**:
- Pop-out çª—å£æœ‰"å®Œå…¨ä¸åŒçš„å…¨å±€å¯¹è±¡é›†"
- æ¯ä¸ªçª—å£æœ‰è‡ªå·±çš„ `Window`ã€`Document` å’Œå…¨å±€æ„é€ å‡½æ•°
- ä¹‹å‰å…³äºå…¨å±€å¯¹è±¡çš„å‡è®¾ä¸å†é€‚ç”¨

**æ–° API**:
- `activeWindow`: å½“å‰èšç„¦çš„çª—å£
- `activeDocument`: å½“å‰èšç„¦çš„ document
- `element.win`: å…ƒç´ æ‰€å±çš„çª—å£
- `element.doc`: å…ƒç´ æ‰€å±çš„ document
- `element.instanceOf(HTMLElement)`: å¯é çš„ç±»å‹æ£€æŸ¥
- `HTMLElement.onWindowMigrated(callback)`: å¤„ç†å…ƒç´ è·¨çª—å£è¿ç§»

### AG Grid ç›¸å…³é—®é¢˜
**GitHub Issues**:
- #3212: å¯ç¼–è¾‘ç½‘æ ¼ä½œä¸ºå¼¹å‡ºç¼–è¾‘å™¨æ—¶æ„å¤–å…³é—­
- #10372: ä» v29 å‡çº§åˆ° v33.2.3 åè‡ªå®šä¹‰ç¼–è¾‘å™¨ä¸å·¥ä½œ
- #3809: ç¼–è¾‘åå¡«å……å¥æŸ„æ¶ˆå¤±

**AG Grid å®˜æ–¹**:
- [Creating Popups in AG Grid](https://blog.ag-grid.com/creating-popups-in-ag-grid/)
- [Popups Limitations](https://ag-grid.zendesk.com/hc/en-us/articles/360006076712-Popups-Limitations)

---

## å½“å‰å‡è®¾

### é—®é¢˜ A çš„å‡è®¾ï¼ˆä¸»çª—å£é¦–å­—ç¬¦ä¸¢å¤±ï¼‰

#### å‡è®¾ A1: AG Grid äº‹ä»¶å¤„ç†æ—¶åºé—®é¢˜ â­ï¸ æœ€æœ‰å¯èƒ½
AG Grid åœ¨æŒ‰é”®å¯åŠ¨ç¼–è¾‘çš„æµç¨‹ä¸­ï¼š
1. æ•è·æŒ‰é”®äº‹ä»¶
2. åˆ›å»ºç¼–è¾‘å™¨å®ä¾‹
3. è°ƒç”¨ `init()` å¹¶ä¼ é€’ `eventKey`
4. å°†ç¼–è¾‘å™¨ DOM æ’å…¥åˆ°å•å…ƒæ ¼
5. è°ƒç”¨ `afterGuiAttached()`
6. **ä½†åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæŒ‰é”®äº‹ä»¶å¯èƒ½è¢«"æ¶ˆè´¹"äº†ä¸¤æ¬¡**

å¯èƒ½çš„åŸå› ï¼š
- AG Grid å†…éƒ¨åœ¨å¯åŠ¨ç¼–è¾‘å‰å·²ç»å°†æŒ‰é”®è¾“å…¥åˆ°æŸä¸ªä¸´æ—¶è¾“å…¥æ¡†
- ç„¶åæ‰åˆ›å»ºæˆ‘ä»¬çš„è‡ªå®šä¹‰ç¼–è¾‘å™¨
- å¯¼è‡´é¦–å­—ç¬¦å·²ç»åœ¨ä¸´æ—¶è¾“å…¥æ¡†ä¸­è¢«å¤„ç†ï¼Œæˆ‘ä»¬æ‹¿åˆ°çš„æ˜¯"å‰©ä½™"çš„è¾“å…¥

#### å‡è®¾ A2: afterGuiAttached æ—¶æœºé—®é¢˜
`afterGuiAttached()` è¢«è°ƒç”¨æ—¶ï¼Œå¯èƒ½ DOM è¿˜æœªå®Œå…¨å°±ç»ªï¼Œå¯¼è‡´ `focus()` å’Œè®¾ç½®å…‰æ ‡ä½ç½®å¤±è´¥ï¼Œè¿›è€Œå¯¼è‡´åç»­è¾“å…¥è¢«é”™è¯¯å¤„ç†ã€‚

#### å‡è®¾ A3: AG Grid å†…éƒ¨æœ‰é»˜è®¤çš„ cellEditor
å³ä½¿æˆ‘ä»¬è®¾ç½®äº† `cellEditor: TextCellEditor`ï¼ŒAG Grid å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ä»ç„¶ä½¿ç”¨é»˜è®¤ç¼–è¾‘å™¨å¤„ç†é¦–å­—ç¬¦ï¼Œç„¶åæ‰åˆ‡æ¢åˆ°æˆ‘ä»¬çš„ç¼–è¾‘å™¨ã€‚

---

### é—®é¢˜ B çš„å‡è®¾ï¼ˆPop-out çª—å£è¡¨æ ¼è§†å›¾æ— æ³•æ¸²æŸ“ï¼‰

#### å‡è®¾ B1: Obsidian è§†å›¾æ³¨å†Œé—®é¢˜ â­ï¸ æœ€æœ‰å¯èƒ½
```typescript
// main.ts
this.registerView(
    TABLE_VIEW_TYPE,
    (leaf) => new TableView(leaf)
);
```
è§†å›¾æ³¨å†Œå¯èƒ½æ˜¯å…¨å±€çš„ï¼Œåªåœ¨ä¸»çª—å£çš„æ’ä»¶ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œï¼Œpop-out çª—å£å¯èƒ½æ— æ³•è®¿é—®è¿™ä¸ªæ³¨å†Œã€‚

#### å‡è®¾ B2: Leaf çŠ¶æ€ä¼ é€’é—®é¢˜
å½“åœ¨ pop-out çª—å£ä¸­æ‰“å¼€è¡¨æ ¼è§†å›¾æ—¶ï¼Œ`setState()` å¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®è°ƒç”¨ï¼Œæˆ–è€… state æ•°æ®ä¸¢å¤±ã€‚

#### å‡è®¾ B3: æ–‡ä»¶è·¯å¾„è§£æé—®é¢˜
åœ¨ pop-out çª—å£ä¸­ï¼Œ`this.app.vault.getAbstractFileByPath(state.filePath)` å¯èƒ½æ— æ³•æ­£ç¡®è§£ææ–‡ä»¶è·¯å¾„ã€‚

#### å‡è®¾ B4: TableView æ„é€ æˆ–ç”Ÿå‘½å‘¨æœŸé—®é¢˜
TableView çš„æ„é€ å‡½æ•°æˆ– `onOpen()` æ–¹æ³•å¯èƒ½åœ¨ pop-out çª—å£ç¯å¢ƒä¸­æŠ›å‡ºäº†æœªæ•è·çš„å¼‚å¸¸ï¼Œå¯¼è‡´è§†å›¾æ— æ³•åˆå§‹åŒ–ã€‚

---

## ä¸‹ä¸€æ­¥è°ƒæŸ¥æ–¹å‘

### é—®é¢˜ A çš„è°ƒæŸ¥æ–¹å‘ï¼ˆä¸»çª—å£é¦–å­—ç¬¦ä¸¢å¤±ï¼‰

#### âœ… å·²å®Œæˆï¼šæ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—
å·²åœ¨ä»£ç ä¸­æ·»åŠ äº†è¯¦ç»†æ—¥å¿—ï¼ˆè§"å°è¯• 4"ï¼‰ï¼Œç¡®è®¤ï¼š
- eventKey æœ‰æ­£ç¡®çš„å€¼
- TextCellEditor è¢«æ­£å¸¸è°ƒç”¨
- é—®é¢˜å‡ºåœ¨æ›´æ·±å±‚çš„ AG Grid å†…éƒ¨æœºåˆ¶

#### ğŸ” A1: ç ”ç©¶ AG Grid é»˜è®¤ç¼–è¾‘å™¨çš„è¡Œä¸º
- é˜…è¯» AG Grid æºç ï¼Œäº†è§£æŒ‰é”®å¯åŠ¨ç¼–è¾‘çš„å®Œæ•´æµç¨‹
- æŸ¥æ‰¾æ˜¯å¦æœ‰é…ç½®é€‰é¡¹å¯ä»¥å®Œå…¨ç¦ç”¨é»˜è®¤ç¼–è¾‘å™¨
- å°è¯•ä½¿ç”¨ `suppressKeyboardEvent` æ‹¦æˆªæ‰€æœ‰æŒ‰é”®ï¼Œæ‰‹åŠ¨ç®¡ç†ç¼–è¾‘å¯åŠ¨

#### ğŸ” A2: å°è¯• popup æ¨¡å¼çš„ç¼–è¾‘å™¨
å°† `isPopup()` è¿”å› `true`ï¼Œè®©ç¼–è¾‘å™¨ä½œä¸ºæµ®å±‚æ˜¾ç¤ºï¼Œå¯èƒ½èƒ½é¿å¼€æŸäº›å†…éƒ¨çš„ DOM æ“ä½œæ—¶åºé—®é¢˜ã€‚

#### ğŸ” A3: ç›‘å¬ AG Grid å†…éƒ¨äº‹ä»¶
```typescript
gridOptions: {
    onCellEditingStarted: (e) => console.log('ç¼–è¾‘å¼€å§‹:', e),
    onCellEditingStopped: (e) => console.log('ç¼–è¾‘åœæ­¢:', e),
    onCellValueChanged: (e) => console.log('å€¼å˜åŒ–:', e),
}
```

#### ğŸ” A4: è”ç³» AG Grid å®˜æ–¹
- åœ¨ AG Grid GitHub æ issue
- åœ¨ AG Grid è®ºå›è¯¢é—®ç¤¾åŒº

---

### é—®é¢˜ B çš„è°ƒæŸ¥æ–¹å‘ï¼ˆPop-out çª—å£è¡¨æ ¼è§†å›¾æ— æ³•æ¸²æŸ“ï¼‰â­ï¸ ä¼˜å…ˆçº§æ›´é«˜

#### âœ… å·²å®Œæˆï¼šæ·»åŠ  TableView.render æ—¥å¿—
å·²ç¡®è®¤ TableView.render åœ¨ pop-out çª—å£ä¸­**æ²¡æœ‰è¢«è°ƒç”¨**ï¼Œé—®é¢˜åœ¨æ›´ä¸Šå±‚ã€‚

#### ğŸ” B1: è°ƒè¯• Obsidian è§†å›¾æ³¨å†Œ â­ï¸â­ï¸â­ï¸ æœ€ä¼˜å…ˆ
åœ¨ `main.ts` ä¸­æ·»åŠ æ—¥å¿—ï¼š
```typescript
// main.ts onload()
console.log('=== æ³¨å†Œ TableView ===');
console.log('TABLE_VIEW_TYPE:', TABLE_VIEW_TYPE);
console.log('å½“å‰ window:', window);

this.registerView(
    TABLE_VIEW_TYPE,
    (leaf) => {
        console.log('=== åˆ›å»º TableView å®ä¾‹ ===');
        console.log('leaf:', leaf);
        console.log('leaf.view.containerEl.ownerDocument:', leaf.view?.containerEl?.ownerDocument);
        return new TableView(leaf);
    }
);
```

#### ğŸ” B2: è°ƒè¯•æ‰“å¼€è¡¨æ ¼è§†å›¾çš„æµç¨‹
åœ¨ `openTableView()` ä¸­æ·»åŠ æ—¥å¿—ï¼š
```typescript
async openTableView(file: TFile) {
    console.log('=== openTableView å¼€å§‹ ===');
    console.log('file:', file);

    const { workspace } = this.app;
    const leaf = workspace.getLeaf(false);

    console.log('leaf:', leaf);
    console.log('leaf.view:', leaf.view);

    await leaf.setViewState({
        type: TABLE_VIEW_TYPE,
        active: true,
        state: { filePath: file.path }
    });

    console.log('setViewState å®Œæˆ');
    workspace.revealLeaf(leaf);
}
```

#### ğŸ” B3: æ£€æŸ¥ TableView æ„é€ å‡½æ•°
åœ¨ TableView æ„é€ å‡½æ•°ä¸­æ·»åŠ æ—¥å¿—å’Œé”™è¯¯æ•è·ï¼š
```typescript
constructor(leaf: WorkspaceLeaf) {
    try {
        console.log('=== TableView æ„é€ å‡½æ•°å¼€å§‹ ===');
        console.log('leaf:', leaf);
        super(leaf);
        console.log('=== TableView æ„é€ å‡½æ•°å®Œæˆ ===');
    } catch (e) {
        console.error('=== TableView æ„é€ å‡½æ•°é”™è¯¯ ===', e);
        throw e;
    }
}
```

#### ğŸ” B4: æ£€æŸ¥ onOpen å’Œ setState
```typescript
async onOpen(): Promise<void> {
    console.log('=== TableView.onOpen å¼€å§‹ ===');
    try {
        const container = this.containerEl.children[1];
        container.addClass("tile-line-base-view");
        console.log('=== TableView.onOpen å®Œæˆ ===');
    } catch (e) {
        console.error('=== TableView.onOpen é”™è¯¯ ===', e);
        throw e;
    }
}

async setState(state: TableViewState, result: any): Promise<void> {
    console.log('=== TableView.setState å¼€å§‹ ===');
    console.log('state:', state);
    try {
        const file = this.app.vault.getAbstractFileByPath(state.filePath);
        console.log('file:', file);
        if (file instanceof TFile) {
            this.file = file;
            await this.render();
        }
        console.log('=== TableView.setState å®Œæˆ ===');
    } catch (e) {
        console.error('=== TableView.setState é”™è¯¯ ===', e);
        throw e;
    }
}
```

#### ğŸ” B5: ç ”ç©¶ Obsidian pop-out çª—å£çš„è§†å›¾ç®¡ç†
- é˜…è¯» Obsidian å®˜æ–¹æ–‡æ¡£å…³äºè§†å›¾æ³¨å†Œçš„éƒ¨åˆ†
- æŸ¥çœ‹å…¶ä»–æ”¯æŒ pop-out çª—å£çš„æ’ä»¶æ˜¯å¦‚ä½•å®ç°çš„
- æœç´¢ Obsidian è®ºå›å…³äº pop-out çª—å£çš„è®¨è®º

---

## ğŸ’¡ å…³é”®æ´å¯Ÿï¼šPop-out çª—å£é—®é¢˜çš„æ ¹æœ¬åŸå› 

**æ¥æº**: `docs/specs/251017 ag-grid è¾“å…¥ä¸¢å¤±é¦–å­—ç¬¦åˆ†æ.md`

### æ ¸å¿ƒé—®é¢˜
ä¸»çª—å£èƒ½è·‘è¯´æ˜ AG Grid è‡ªèº«æ²¡é—®é¢˜ï¼›æ–°çª—å£ä¸æ¸²æŸ“æ˜¯å› ä¸º**å…¨å±€å¯¹è±¡ç”¨é”™çª—å£äº†**ã€‚

### æ ¹æœ¬åŸå› 
åœ¨ Obsidian ä¸­ï¼Œæ¯ä¸ª pop-out çª—å£éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ï¼š
- `window` å¯¹è±¡
- `document` å¯¹è±¡
- `app` å¯¹è±¡
- `workspace` å¯¹è±¡

å¦‚æœç»§ç»­ä½¿ç”¨å…¨å±€çš„ `this.app.workspace` æˆ– `document`ï¼Œé‚£åªä¼šæ“ä½œä¸»çª—å£ï¼Œpop-out çª—å£è‡ªç„¶å°±é™é»˜äº†ã€‚

### è§£å†³æ–¹å‘ â­ï¸â­ï¸â­ï¸

#### 1. è§†å›¾æ³¨å†Œå’Œæ‰“å¼€å¿…é¡»é’ˆå¯¹å½“å‰çª—å£
- æ’ä»¶çš„ `registerView` å…¨å±€åªéœ€è¦ä¸€æ¬¡
- ä½†åœ¨å®é™…"æ‰“å¼€è§†å›¾"æ—¶ï¼Œè¦ç¡®ä¿æ˜¯é€šè¿‡**è§¦å‘è¯¥çª—å£çš„ workspace** å»åš

**éœ€è¦ä¿®æ”¹çš„åœ°æ–¹**:
```typescript
// main.ts - openTableView()
async openTableView(file: TFile) {
    const { workspace } = this.app;

    // âŒ é”™è¯¯ï¼šæ€»æ˜¯ä½¿ç”¨ä¸»çª—å£çš„ workspace
    const leaf = workspace.getLeaf(false);

    // âœ… æ­£ç¡®ï¼šæ‰¾åˆ°è§¦å‘çš„ leafï¼Œä½¿ç”¨å®ƒæ‰€åœ¨çª—å£çš„ workspace
    // éœ€è¦ä»äº‹ä»¶æˆ–ä¸Šä¸‹æ–‡ä¸­è·å–å½“å‰çª—å£çš„ workspace
}
```

#### 2. DOM å…ƒç´ å¿…é¡»æŒ‚åœ¨è¯¥çª—å£çš„ document ä¸Š
æ‰€æœ‰ `createElement`ã€`activeElement`ã€`body.classList` éƒ½è¦ä½¿ç”¨ `containerEl.ownerDocument`ã€‚

**å·²å®Œæˆ**: âœ… è¿™éƒ¨åˆ†åœ¨"å°è¯• 2"ä¸­å·²ç»ä¿®å¤

#### 3. åˆå§‹åŒ–æ—¶æœºé—®é¢˜
åœ¨ pop-out çª—å£ï¼Œå…ƒç´ æŒ‚è½½åˆ° DOM çš„èŠ‚å¥å’Œä¸»çª—å£ä¸ä¸€æ ·ã€‚è¦åœ¨å®ƒçœŸæ­£ attach åˆ°é‚£ä¸ª document åå†åˆå§‹åŒ– Gridã€‚

**éœ€è¦æ·»åŠ **:
```typescript
// TableView.ts - render()
const ownerWindow = (container as HTMLElement).ownerDocument.defaultView;
if (ownerWindow) {
    ownerWindow.requestAnimationFrame(() => {
        // åœ¨è¿™é‡Œåˆå§‹åŒ– AG Grid
        this.gridAdapter = new AgGridAdapter();
        this.gridAdapter.mount(tableContainer, columns, data, context);
    });
}
```

### ğŸ›  å®æ–½è®°å½•ï¼ˆ2025-10-20ï¼‰

1. **äº‹ä»¶ä¸Šä¸‹æ–‡æ•è·**ï¼š`MenuItem.onClick` ä¼šæŠŠè§¦å‘çª—å£çš„ `MouseEvent` ä¼ è¿›æ¥ï¼Œ`evt.view` å°±æ˜¯å½“å‰ pop-out çš„ `window`ã€‚æ–°å¢ `resolveLeafFromEvent()`ï¼Œä¼˜å…ˆç”¨ `evt.view`ã€`activeWindow` æ˜ å°„å‡ºç›®æ ‡çª—å£ã€‚
2. **å¶å­å®šä½ç­–ç•¥**ï¼šå®ç° `findLeafForWindow()`ï¼Œéå† `workspace.iterateAllLeaves`ï¼Œç”¨ `leaf.view.containerEl.ownerDocument.defaultView` åŒ¹é…çª—å£ï¼Œä¿è¯åœ¨å¯¹åº” pop-out ä¸­å¤ç”¨ç°æœ‰ leafï¼Œæ‰¾ä¸åˆ°æ—¶å†é€€å›åˆ° `activeLeaf â†’ getMostRecentLeaf â†’ getLeaf(false)`ã€‚
3. **openTableView æ¥å£è°ƒæ•´**ï¼šå…è®¸ä¼ å…¥ç›®æ ‡ leafï¼Œæ–‡ä»¶èœå•ä¸å‘½ä»¤å›è°ƒéƒ½ä½¿ç”¨æ–°çš„è§£æé€»è¾‘ï¼Œé¿å…é»˜è®¤è½åˆ°ä¸»çª—å£çš„ `workspace.getLeaf(false)`ã€‚
4. **æ¸²æŸ“å»¶è¿Ÿ**ï¼š`TableView.render()` åœ¨æ‹¿åˆ° `container.ownerDocument.defaultView` åï¼Œç”¨è¯¥çª—å£çš„ `requestAnimationFrame` å»¶è¿Ÿåˆå§‹åŒ– `AgGridAdapter.mount`ï¼Œç¡®ä¿ pop-out DOM å·² attachã€‚
5. **å¾…éªŒè¯**ï¼š`npm run build` é€šè¿‡åï¼Œåœ¨ä¸»çª—å£ä¸ pop-out ä¸­åˆ†åˆ«æµ‹è¯•ï¼šå³é”®æ–‡ä»¶æ‰“å¼€è¡¨æ ¼ã€å‘½ä»¤é¢æ¿åˆ‡æ¢ã€é¦–å­—ç¬¦ç¼–è¾‘å›å½’æµ‹è¯•ï¼Œä»¥åŠè§‚å¯Ÿå¤šæ¬¡å¼¹å‡ºçª—å£çš„ leaf é€‰æ‹©æ˜¯å¦ç¨³å®šã€‚

### âŒ éªŒè¯åé¦ˆï¼ˆ2025-10-21ï¼‰

- å®é™…éªŒè¯ï¼šåœ¨ pop-out çª—å£é€šè¿‡æ–‡ä»¶èœå•æˆ–å‘½ä»¤é¢æ¿è§¦å‘åï¼Œä¾ç„¶æ²¡æœ‰ `TableView.render` ç›¸å…³æ—¥å¿—ï¼Œè¡¨æ ¼æœªæ¸²æŸ“ã€‚
- è°ƒè¯•è§‚å¯Ÿï¼š`resolveLeafFromEvent()` å¤§å¤šæ•°æƒ…å†µä¸‹æ‹¿ä¸åˆ°ç›®æ ‡çª—å£ï¼Œ`iterateAllLeaves` åŒ¹é…å¤±è´¥ååˆè½å› `getLeaf(false)`ï¼Œæœ€ç»ˆè¿˜æ˜¯å¤ç”¨äº†ä¸»çª—å£çš„ leafã€‚
- ç»“è®ºï¼šå½“å‰å®ç°åªèƒ½ä¿è¯ä¸»çª—å£æ­£å¸¸ï¼Œpop-out ä»ç„¶æ²¡æœ‰å®ä¾‹åŒ– TableViewï¼Œé—®é¢˜æœªè§£å†³ã€‚

### ğŸ¯ ä¸‹ä¸€æ­¥è°ƒè¯•æ–¹å‘ï¼ˆ2025-10-21ï¼‰

1. **è®°å½•è§¦å‘çª—å£ä¸Šä¸‹æ–‡**ï¼šåœ¨ `window-open` äº‹ä»¶é‡Œä¸ºæ–°çª—å£æ³¨å†Œç‹¬ç«‹çš„ `file-menu` ç›‘å¬ï¼Œå¹¶ç¼“å­˜ `win.app.workspace`ï¼Œé¿å…å›é€€åˆ°ä¸»çª—å£å®ä¾‹ã€‚
2. **è¡¥å…¨å‘½ä»¤å…¥å£ä¸Šä¸‹æ–‡**ï¼šå‘½ä»¤é¢æ¿è§¦å‘æ—¶æ²¡æœ‰äº‹ä»¶å¯¹è±¡ï¼Œéœ€è¦åœ¨ `toggleTableView` é‡Œæ ¹æ® `leaf.getRoot()` æˆ– `leaf.view.containerEl.ownerDocument.defaultView` æ¨å¯¼çª—å£ï¼Œå†æŠŠ leaf ä¼ å…¥ `openTableView`ã€‚
3. **å…œåº•åˆ›å»º leaf**ï¼šå½“ pop-out ä¸­æ²¡æœ‰åŒ¹é… leaf æ—¶ï¼Œå°è¯•è°ƒç”¨ `workspace.getLeaf('window')` æˆ– `leaf.getRoot().getLeaf()` åœ¨è¯¥çª—å£åˆ›å»ºæ–°çš„é¢æ¿ï¼Œè€Œä¸æ˜¯å›è½ä¸»çª—å£ã€‚
4. **éªŒè¯æ—¥å¿—é“¾è·¯**ï¼šä¸º `resolveLeafFromEvent`ã€`findLeafForWindow`ã€`TableView.render` è¡¥å……çª—å£æ ‡è¯†ï¼ˆå¦‚ `window.location.href` æˆ– `winId`ï¼‰ï¼Œç¡®è®¤æ•´ä¸ªé“¾æ¡åœ¨å“ªä¸€æ­¥ä¸¢å¤±ä¸Šä¸‹æ–‡ã€‚

### ğŸ›  å®æ–½è®°å½•ï¼ˆ2025-10-21 ç¬¬äºŒè½®ï¼‰

- **å¤šçª—å£æ—¥å¿—é“¾è·¯**ï¼š`src/main.ts` æ–°å¢ `LOG_PREFIX`ï¼Œä¸º `file-menu`ã€`toggle-table-view`ã€`resolveLeafFromEvent`ã€`findLeafForWindow`ã€`openTableView` ç­‰èŠ‚ç‚¹è¾“å‡ºçª—å£ `id/href`ã€leaf æ‰€å±çª—å£ã€åŒ¹é…è¿‡ç¨‹ä¸å…œåº•è·¯å¾„ã€‚
- **çª—å£ç”Ÿå‘½å‘¨æœŸç›‘å¬**ï¼šç›‘å¬ `workspace.on('window-open'/'window-close')`ï¼Œç¼“å­˜æ¯ä¸ªçª—å£çš„ `App`/`Workspace` å¼•ç”¨ï¼Œå¹¶åœ¨æ—¥å¿—ä¸­æ ‡è¯†æ˜¯å¦å·²ç™»è®°ã€‚
- **çª—å£ä¸“å±æ³¨å†Œ**ï¼šæ¯ä¸ªçª—å£éƒ½ä¼šé‡æ–°æ³¨å†Œ `file-menu` å¤„ç†é€»è¾‘ï¼Œå¹¶åœ¨å‘½ä»¤æ‰§è¡Œæ—¶æ ¹æ® leaf æ‰€å±çª—å£å›æº¯åˆ°è¯¥çª—å£çš„ workspaceã€‚
- **leaf å…œåº•ç­–ç•¥**ï¼š`openTableView` æ¥å— `{ leaf, preferredWindow, workspace }`ï¼Œä¼˜å…ˆä½¿ç”¨å‘½ä¸­çš„ leafï¼Œå…¶æ¬¡åœ¨ç›®æ ‡çª—å£çš„ workspace å†…ç­›é€‰/è¿­ä»£ leafï¼Œæœ€åå°è¯•è°ƒç”¨ `workspace.getLeaf(true)` åœ¨è¯¥çª—å£åˆ›å»ºæ–° leafã€‚
- **TableView æ¸²æŸ“æ—¥å¿—**ï¼š`src/TableView.ts` è®°å½•è¡¨æ ¼æ¸²æŸ“æ—¶çš„ `ownerDocument`ã€`window.location.href`ï¼Œä»¥åŠæŒ‚è½½é˜¶æ®µä½¿ç”¨çš„çª—å£ï¼Œä¾¿äºç¡®è®¤ pop-out DOM æ˜¯å¦æˆåŠŸè½åœ¨ç‹¬ç«‹ document ä¸‹ã€‚
- **æ„å»ºæ ¡éªŒ**ï¼š`npm run build` é€šè¿‡ï¼Œä¿è¯ TypeScript ä¸æ„å»ºæµç¨‹åœ¨æ–°å¢æ—¥å¿—/é€»è¾‘åä»å¯ç¼–è¯‘ã€‚


### âŒ éªŒè¯åé¦ˆï¼ˆ2025-10-21 æ™šï¼‰

- Pop-out ä¸­è§¦å‘åæ—¥å¿—ä»ç„¶åœåœ¨ `selectLeaf -> workspace.getLeaf(false)`ï¼Œè¯´æ˜ä¾æ—§è½å›ä¸»çª—å£çš„ workspaceï¼Œ`openTableView setViewState` åªåœ¨ä¸»çª—å£æ‰§è¡Œã€‚
- `createLeafInWindow via workspace.getLeaf(true)` è¿”å›çš„ leaf ä»ç„¶å½’å±ä¸»çª—å£ï¼ˆæ—¥å¿—é‡Œ `leafWindow.isMain === true`ï¼‰ï¼Œæœªèƒ½åœ¨ pop-out ä¸­åˆ›å»ºæ–° leafã€‚
- `TableView.render` ä¾æ—§æ‰“å°ä¸åˆ° pop-out çª—å£çš„ `ownerDocument`ï¼Œç¡®è®¤è§†å›¾æ²¡æœ‰åœ¨æ–°çª—å£å®ä¾‹åŒ–ã€‚

### âœï¸ TODOï¼ˆä¸‹ä¸€è½®ï¼‰

1. è°ƒç ” `workspaceWindow.getRoot()` / `WorkspaceSplit` APIï¼Œçœ‹æ˜¯å¦èƒ½ç›´æ¥å¾—åˆ° pop-out è‡ªå·±çš„ root splitï¼Œä»è€Œåœ¨è¯¥ split ä¸‹åˆ›å»º leafã€‚
2. è€ƒè™‘åœ¨ `window-open` æ—¶æ‰‹åŠ¨é€šè¿‡ `win.require('electron')` æˆ– `win.app.workspace.getLeaf(true)` éªŒè¯è¿”å›å€¼ï¼Œç¡®è®¤ pop-out workspace å…·å¤‡æ­£å¸¸èƒ½åŠ›ã€‚
3. å¦‚æœ‰å¿…è¦ï¼Œæ¯”è¾ƒå®˜æ–¹æ”¯æŒ pop-out çš„æ’ä»¶ä»£ç ï¼ˆå¦‚ Dataviewã€Kanbanï¼‰åœ¨ pop-out åˆå§‹åŒ–æ—¶çš„è°ƒç”¨æ–¹å¼ï¼Œæ”¶é›†å…·ä½“ APIï¼›å°†ç»“è®ºè®°å½•è‡³ specsã€‚
### ğŸ” å¾…æ‰§è¡ŒéªŒè¯

- åœ¨ä¸»çª—å£ä¸ pop-out åˆ†åˆ«è§¦å‘æ–‡ä»¶èœå•å’Œå‘½ä»¤é¢æ¿æ“ä½œï¼Œæ”¶é›†æ–°çš„ `[TileLineBase]` æ—¥å¿—ï¼Œæ£€æŸ¥ `resolveLeafFromEvent` æ˜¯å¦èƒ½å‘½ä¸­ç›®æ ‡çª—å£æˆ–æˆåŠŸè°ƒç”¨ `createLeafInWindow`ã€‚
- æ ¹æ®æ—¥å¿—åˆ¤æ–­ `workspaceWindow.getLeaf(false)` æ˜¯å¦åœ¨ pop-out ä¸­è¿”å›æœ‰æ•ˆ leafï¼›è‹¥ä»ä¸º `null`ï¼Œéœ€æ¢ç´¢æ›´å¯é çš„çª—å£å†… leaf åˆ›å»ºæ–¹å¼ã€‚

---

## ğŸ”¬ æ·±åº¦åˆ†æï¼šObsidian å¤šçª—å£æ¶æ„ï¼ˆ2025-10-22ï¼‰

### å…³é”®å‘ç°ï¼šApp å’Œ Workspace çš„å…±äº«æœºåˆ¶

ç»è¿‡ä»£ç å®¡æŸ¥å‘ç°ï¼Œå½“å‰å®ç°ä¸­å­˜åœ¨ä¸€ä¸ªå…³é”®å‡è®¾é—®é¢˜ï¼š

**ä»£ç ä¸­çš„å‡è®¾**ï¼ˆ`main.ts:92`ï¼‰ï¼š
```typescript
const winApp = (win as any).app as App | undefined;
const app = winApp ?? this.app;
```

è¿™æ®µä»£ç å‡è®¾æ¯ä¸ªçª—å£æœ‰ç‹¬ç«‹çš„ `app` å®ä¾‹ï¼Œä½†å®é™…æƒ…å†µå¯èƒ½æ˜¯ï¼š

#### å‡è®¾ 1ï¼šå…¨å±€å…±äº«æ¶æ„ â­ï¸ æœ€æœ‰å¯èƒ½
- **æ‰€æœ‰çª—å£å…±äº«åŒä¸€ä¸ª `app` å®ä¾‹**
- **æ‰€æœ‰çª—å£å…±äº«åŒä¸€ä¸ª `workspace` å®ä¾‹**
- ä½†æ¯ä¸ªçª—å£æœ‰ç‹¬ç«‹çš„ `Window` å’Œ `Document` å¯¹è±¡
- `workspace` ç®¡ç†æ‰€æœ‰çª—å£çš„ leavesï¼Œé€šè¿‡ `WorkspaceWindow` æ¥åŒºåˆ†

**è¯æ®**ï¼š
1. `workspace.on('window-open')` äº‹ä»¶åœ¨ä¸»çª—å£çš„æ’ä»¶ä¸­å°±èƒ½ç›‘å¬åˆ°æ‰€æœ‰çª—å£
2. `workspace.iterateAllLeaves()` å¯ä»¥éå†æ‰€æœ‰çª—å£çš„ leaves
3. æ–‡æ¡£ä¸­æåˆ°çš„"å…¨å±€å¯¹è±¡"é—®é¢˜ä¸»è¦æŒ‡ `Window` å’Œ `Document`ï¼Œè€Œé `App`

#### å‡è®¾ 2ï¼šçœŸæ­£çš„é—®é¢˜æ‰€åœ¨
é—®é¢˜ä¸åœ¨äº `app` æˆ– `workspace` æ˜¯å¦ç‹¬ç«‹ï¼Œè€Œåœ¨äºï¼š

**`workspace.getLeaf(false/true)` ä¸æ¥å—çª—å£å‚æ•°**ï¼Œå®ƒåŸºäºä»¥ä¸‹é€»è¾‘ï¼š
- `workspace.activeLeaf`ï¼šå½“å‰æ¿€æ´»çš„ leafï¼ˆå¯èƒ½åœ¨ä»»ä½•çª—å£ï¼‰
- `workspace.getMostRecentLeaf()`ï¼šæœ€è¿‘ä½¿ç”¨çš„ leaf
- åˆ›å»ºæ–° leaf æ—¶ï¼Œé»˜è®¤åœ¨"æŸä¸ª"çª—å£ä¸­åˆ›å»ºï¼Œä½†**æ— æ³•æŒ‡å®šç›®æ ‡çª—å£**

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ**ï¼š
- åœ¨ pop-out çª—å£è§¦å‘æ“ä½œæ—¶ï¼Œå¦‚æœä¸»çª—å£æ˜¯"active"çš„ï¼Œ`workspace.getLeaf(false)` ä¼šè¿”å›ä¸»çª—å£çš„ leaf
- `workspace.getLeaf(true)` åˆ›å»ºæ–° leaf æ—¶ï¼Œå¯èƒ½ä¹Ÿé»˜è®¤åœ¨ä¸»çª—å£åˆ›å»º

### æ­£ç¡®çš„è§£å†³æ–¹å‘

#### æ–¹æ³• 1ï¼šä½¿ç”¨ WorkspaceWindow API â­ï¸â­ï¸â­ï¸ æœ€ä¼˜å…ˆ
`WorkspaceWindow` å¯¹è±¡åº”è¯¥åŒ…å«è®¿é—®è¯¥çª—å£ leaves çš„æ–¹æ³•ï¼š

```typescript
// å¯èƒ½çš„ APIï¼ˆéœ€è¦éªŒè¯ï¼‰:
workspaceWindow.getRoot()        // è¿”å›è¯¥çª—å£çš„æ ¹ WorkspaceSplit
workspaceWindow.activeLeaf       // è¯¥çª—å£çš„æ´»è·ƒ leaf
root.getLeaf(newLeaf: boolean)   // åœ¨è¯¥ split ä¸‹è·å–/åˆ›å»º leaf
```

**éªŒè¯è®¡åˆ’**ï¼š
åœ¨ `window-open` äº‹ä»¶ä¸­è¯¦ç»†æ¢æŸ¥ `WorkspaceWindow` å¯¹è±¡ï¼š
```typescript
this.app.workspace.on('window-open', (workspaceWindow, win) => {
    console.log('=== WorkspaceWindow è¯¦ç»†ä¿¡æ¯ ===');
    console.log('workspaceWindow:', workspaceWindow);
    console.log('å¯ç”¨å±æ€§:', Object.keys(workspaceWindow));
    console.log('å¯ç”¨æ–¹æ³•:', Object.getOwnPropertyNames(Object.getPrototypeOf(workspaceWindow)));

    // å°è¯•è®¿é—®å¯èƒ½çš„ API
    if ('getRoot' in workspaceWindow) {
        const root = (workspaceWindow as any).getRoot();
        console.log('workspaceWindow.getRoot():', root);
    }

    if ('activeLeaf' in workspaceWindow) {
        console.log('workspaceWindow.activeLeaf:', (workspaceWindow as any).activeLeaf);
    }
});
```

#### æ–¹æ³• 2ï¼šé€šè¿‡ leaf.getRoot() è·å–çª—å£çš„æ ¹ split
å½“å·²ç»æœ‰ä¸€ä¸ª leaf æ—¶ï¼Œå¯ä»¥é€šè¿‡å®ƒå›æº¯åˆ°æ‰€åœ¨çª—å£çš„æ ¹ï¼š

```typescript
const currentLeaf = workspace.activeLeaf;
if (currentLeaf) {
    const root = currentLeaf.getRoot?.();  // è·å–æ ¹ split
    const newLeaf = root?.getLeaf?.(true); // åœ¨åŒä¸€çª—å£åˆ›å»ºæ–° leaf
}
```

#### æ–¹æ³• 3ï¼šä½¿ç”¨ activeLeaf ä½œä¸ºé”šç‚¹
åœ¨è§¦å‘æ“ä½œæ—¶ï¼Œ`workspace.activeLeaf` åº”è¯¥æŒ‡å‘è§¦å‘çª—å£çš„æ´»è·ƒ leafï¼š

```typescript
// åœ¨æ–‡ä»¶èœå•æˆ–å‘½ä»¤è§¦å‘æ—¶
const triggerLeaf = this.app.workspace.activeLeaf;
const triggerWindow = triggerLeaf?.view?.containerEl?.ownerDocument?.defaultView;

// å¦‚æœ triggerWindow åŒ¹é…ç›®æ ‡çª—å£ï¼Œç›´æ¥ä½¿ç”¨ triggerLeaf
// å¦åˆ™éœ€è¦åœ¨ç›®æ ‡çª—å£ä¸­æŸ¥æ‰¾æˆ–åˆ›å»º leaf
```

### éœ€è¦éªŒè¯çš„æ ¸å¿ƒé—®é¢˜

1. **`win.app` æ˜¯å¦ç­‰äº `this.app`ï¼Ÿ**
   - å¦‚æœç›¸ç­‰ï¼Œè¯´æ˜ app æ˜¯å…¨å±€å…±äº«çš„
   - å¦‚æœä¸ç­‰ï¼Œè¯´æ˜æ¯ä¸ªçª—å£æœ‰ç‹¬ç«‹çš„ app å®ä¾‹

2. **`WorkspaceWindow` æä¾›äº†å“ªäº› APIï¼Ÿ**
   - æ˜¯å¦æœ‰ `getRoot()` æ–¹æ³•ï¼Ÿ
   - æ˜¯å¦æœ‰ `activeLeaf` å±æ€§ï¼Ÿ
   - æ˜¯å¦æœ‰å…¶ä»–è®¿é—®è¯¥çª—å£ leaves çš„æ–¹æ³•ï¼Ÿ

3. **`workspace.getLeaf(true)` åœ¨å“ªä¸ªçª—å£åˆ›å»º leafï¼Ÿ**
   - æ˜¯å¦æ€»æ˜¯åœ¨ä¸»çª—å£ï¼Ÿ
   - æ˜¯å¦åœ¨å½“å‰ active çª—å£ï¼Ÿ
   - èƒ½å¦é€šè¿‡æŸç§æ–¹å¼æŒ‡å®šç›®æ ‡çª—å£ï¼Ÿ

4. **å…¶ä»–æˆåŠŸæ”¯æŒ pop-out çš„æ’ä»¶å¦‚ä½•å®ç°ï¼Ÿ**
   - Dataview æ’ä»¶çš„å®ç°æ–¹å¼
   - Kanban æ’ä»¶çš„å®ç°æ–¹å¼
   - å®˜æ–¹ç¤ºä¾‹æˆ–æœ€ä½³å®è·µ

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

#### ç¬¬ä¸€æ­¥ï¼šæ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—ï¼ˆç«‹å³æ‰§è¡Œï¼‰
åœ¨ `main.ts` ä¸­æ·»åŠ å…¨é¢çš„ API æ¢æŸ¥æ—¥å¿—ï¼Œæ­ç¤º Obsidian çš„çœŸå®è¡Œä¸ºã€‚

#### ç¬¬äºŒæ­¥ï¼šç ”ç©¶æˆåŠŸæ¡ˆä¾‹ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
æŸ¥æ‰¾å¹¶åˆ†æå·²æˆåŠŸæ”¯æŒ pop-out çª—å£çš„ Obsidian æ’ä»¶æºç ã€‚

#### ç¬¬ä¸‰æ­¥ï¼šæ ¹æ®å‘ç°å®æ–½ä¿®å¤ï¼ˆåŸºäºå‰ä¸¤æ­¥ç»“æœï¼‰
æ ¹æ® API æ¢æŸ¥å’ŒæˆåŠŸæ¡ˆä¾‹çš„å‘ç°ï¼Œå®æ–½æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆã€‚

#### 4. Grid é…ç½®å¿…é¡»æŒ‡å‘è¯¥çª—å£
**å·²å®Œæˆ**: âœ… åœ¨"å°è¯• 3"ä¸­å·²ç»é…ç½®äº† `popupParent: ownerDoc.body`

#### 5. ç›‘å¬ window-open äº‹ä»¶
éœ€è¦ç›‘å¬ Obsidian çš„ `window-open` äº‹ä»¶ï¼Œåœ¨æ¯ä¸ªæ–°çª—å£é‡Œè¡¥å……å¿…è¦çš„åˆå§‹åŒ–é€»è¾‘ï¼ˆæ ·å¼ã€èœå•ã€ç»‘å®šï¼‰ã€‚

**éœ€è¦æ·»åŠ **:
```typescript
// main.ts
this.registerEvent(
    this.app.workspace.on('window-open', (win, window) => {
        console.log('æ–°çª—å£æ‰“å¼€:', window);
        // åœ¨æ–°çª—å£ä¸­åˆå§‹åŒ–å¿…è¦çš„ä¸œè¥¿
    })
);
```

### ä¼˜å…ˆçº§æ’åº

1. **ğŸ”¥ æœ€é«˜ä¼˜å…ˆçº§**ï¼šä¿®å¤è§†å›¾æ‰“å¼€é€»è¾‘ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çª—å£çš„ workspace
2. **ğŸ”¥ é«˜ä¼˜å…ˆçº§**ï¼šæ·»åŠ åˆå§‹åŒ–æ—¶æœºå»¶è¿Ÿï¼ˆrequestAnimationFrameï¼‰
3. **ğŸ“Œ ä¸­ä¼˜å…ˆçº§**ï¼šç›‘å¬ window-open äº‹ä»¶
4. **âœ… å·²å®Œæˆ**ï¼šDOM å…ƒç´  ownerDocument ä¿®å¤
5. **âœ… å·²å®Œæˆ**ï¼šAG Grid popupParent é…ç½®

---

## å‚è€ƒèµ„æ–™

### Obsidian
- [How to update your plugin to support pop-out windows](https://obsidian.md/blog/how-to-update-plugins-to-support-pop-out-windows/)
- [Pop-out windows - Obsidian Help](https://help.obsidian.md/pop-out-windows)

### AG Grid
- [Cell Editing - AG Grid](https://www.ag-grid.com/javascript-data-grid/cell-editing/)
- [Start/Stop Cell Editing - AG Grid](https://www.ag-grid.com/javascript-data-grid/cell-editing-start-stop/)
- [Creating Popups in AG Grid](https://blog.ag-grid.com/creating-popups-in-ag-grid/)
- [GitHub - ag-grid/ag-grid](https://github.com/ag-grid/ag-grid)

---

## ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

ç›®å‰æ²¡æœ‰å®Œå…¨å¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚å»ºè®®çš„ä¸´æ—¶æªæ–½ï¼š

1. **ä¸»çª—å£**: ç”¨æˆ·ä½¿ç”¨åŒå‡»è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼ˆè€Œéç›´æ¥æŒ‰é”®ï¼‰
2. **Pop-out çª—å£**: æš‚æ—¶åœ¨ pop-out çª—å£ä¸­ç¦ç”¨è¡¨æ ¼è§†å›¾æˆ–ç¼–è¾‘åŠŸèƒ½
3. **ç”¨æˆ·æç¤º**: åœ¨ç•Œé¢ä¸Šæç¤ºç”¨æˆ·å·²çŸ¥çš„é™åˆ¶

---

## åŸå§‹æ’æŸ¥æ€è·¯ï¼ˆä¿ç•™å‚è€ƒï¼‰

---

## å¯èƒ½åŸå›  & æ’æŸ¥æ€è·¯

1. **æ²¡æœ‰å¼€å¯ç¼–è¾‘æ¨¡å¼ / editable å±æ€§æ²¡è®¾ç½®æ­£ç¡®**
    
    - åœ¨ ag-grid ä¸­ï¼Œæƒ³è®©æŸåˆ—èƒ½ç¼–è¾‘ï¼Œéœ€è¦åœ¨ `colDef` ä¸Šè®¾ç½® `editable: true` ï¼ˆæˆ–ä¸€ä¸ªè¿”å›å¸ƒå°”å€¼çš„å‡½æ•°ï¼‰ ([ag-grid.com](https://www.ag-grid.com/javascript-data-grid/cell-editing/?utm_source=chatgpt.com "JavaScript Grid: Cell Editing | AG Grid"))
        
    - å¦‚æœ editable æ¡ä»¶æ˜¯åŠ¨æ€åˆ¤æ–­ï¼Œæœ‰å¯èƒ½åœ¨æŸäº›çŠ¶æ€ä¸‹è¿”å› falseï¼Œå°±é˜»æ­¢ç¼–è¾‘ã€‚
        
2. **ç¼–è¾‘ç”Ÿå‘½å‘¨æœŸ / ç„¦ç‚¹ä¸¢å¤±å¯¼è‡´ç¼–è¾‘åœæ­¢**
    
    - ag-grid çš„ç¼–è¾‘æœ‰ç”Ÿå‘½å‘¨æœŸï¼š`startEditing`ã€`stopEditing` ç­‰ç­‰ã€‚è¡¨æ ¼åœ¨å¤±å»ç„¦ç‚¹æˆ–åˆ‡æ¢å•å…ƒæ ¼æ—¶å¯èƒ½ä¼šè‡ªåŠ¨åœæ­¢ç¼–è¾‘ã€‚([ag-grid.com](https://www.ag-grid.com/javascript-data-grid/cell-editing-start-stop/?utm_source=chatgpt.com "JavaScript Grid: Start/Stop Cell Editing"))
        
    - â€œè¢«åƒæ‰â€ çš„æ„Ÿè§‰å¯èƒ½æ˜¯ï¼šä½ è¾“å…¥äº†å€¼ï¼Œä½†ç¼–è¾‘å™¨ï¼ˆinput å…ƒç´ ï¼‰è¢«é”€æ¯ã€ç¼–è¾‘ç»ˆæ­¢ï¼Œè€Œæ–°çš„å€¼æ²¡è¢«æäº¤ï¼ˆcommitï¼‰åˆ° data model ä¸Šã€‚
        
    - æœ‰å¯èƒ½æ˜¯ä½ ç‚¹å‡»å…¶å®ƒåœ°æ–¹è§¦å‘äº† `stopEditing`ï¼Œè€Œè¯¥åœæ­¢ç¼–è¾‘æ²¡æœ‰æŠŠæ–°çš„å€¼å†™å›å»ã€‚
        
3. **å˜æ›´æ£€æµ‹ / æ•°æ®åˆ·æ–°ï¼ˆView Refreshï¼‰è¦†ç›–äº†è¾“å…¥**
    
    - ag-grid æœ‰è§†å›¾åˆ·æ–°çš„æœºåˆ¶å’Œå˜æ›´æ£€æµ‹æœºåˆ¶ã€‚([ag-grid.com](https://www.ag-grid.com/javascript-data-grid/view-refresh/?utm_source=chatgpt.com "JavaScript Grid: View Refresh"))
        
    - å¦‚æœä½ åœ¨è¾“å…¥è¿‡ç¨‹ä¸­ï¼Œå¤–éƒ¨æœ‰æœºåˆ¶ï¼ˆå®šæ—¶å™¨ã€çˆ¶ç»„ä»¶ state æ›´æ–°ã€æ•°æ®æºé‡ç½®ã€API è°ƒç”¨ç­‰ï¼‰é‡æ–°ç»™ grid ä¼ å…¥ `rowData` æˆ–é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼Œå¯èƒ½ä¼šè¦†ç›–ä½ åˆšæ‰åœ¨ç¼–è¾‘å™¨é‡Œè¾“å…¥ä½†è¿˜æ²¡æäº¤çš„æ•°æ®ã€‚
        
4. **ä½¿ç”¨äº†è‡ªå®šä¹‰ cellRenderer / cellEditor æˆ– â€œå•å‘ç»‘å®šâ€ é”™è¯¯**
    
    - å¦‚æœä½ ä¸ºåˆ—å†™äº†è‡ªå®šä¹‰çš„ç¼–è¾‘å™¨ï¼ˆcellEditorï¼‰ï¼Œé‚£ä¹ˆä½ å¿…é¡»ç¡®ä¿è¿™ä¸ªç¼–è¾‘å™¨åœ¨ `getValue()`ï¼ˆæˆ–ç­‰ä»·å‡½æ•°ï¼‰é‡ŒæŠŠç”¨æˆ·è¾“å…¥å€¼è¿”å›ã€æäº¤ç»™ gridï¼Œå¦åˆ™ grid ä¸çŸ¥é“ä½ è¾“å…¥äº†ä»€ä¹ˆã€‚
        
    - æˆ–è€…è‡ªå®šä¹‰æ¸²æŸ“å™¨é‡Œè¯»å–æ•°æ®æºæ—¶ç”¨é”™è¯¯æ–¹å¼ï¼ˆæ¯”å¦‚å¿½ç•¥ä¸´æ—¶ç¼–è¾‘çŠ¶æ€ï¼‰ï¼Œå¯¼è‡´ä½ çš„ä¿®æ”¹è¢« â€œä¸¢å¼ƒâ€ã€‚
        
5. **è¡¨æ ¼ â€œé‡ç½®â€ / rowData æ›¿æ¢ä¸ºæ–°çš„å¯¹è±¡**
    
    - å‡è®¾åœ¨è¾“å…¥è¿‡ç¨‹ä¸­ï¼Œä½ çš„å¤–å±‚ä»£ç ï¼ˆReactã€Angularã€Vueï¼‰ç›‘æµ‹åˆ°æŸäº›çŠ¶æ€å˜åŒ–ï¼ˆpropsã€state å˜åŒ–ã€åç«¯æ‹‰æ•°æ®ï¼‰å°±æŠŠ `rowData` æ•´å—æ›¿æ¢äº†ã€‚è¿™ä¼šè®© grid çœ‹åˆ° â€œæ–°æ•°æ®â€ è¦†ç›–ä½ åˆšæ‰è¿˜æ²¡æäº¤çš„é‚£æ¬¡ç¼–è¾‘ã€‚
        
    - å› ä¸º ag-grid é»˜è®¤ä¸ä¼šå¯¹ rowData åšæ·±æ‹·è´ï¼ˆé™¤éä½ ç‰¹åˆ«è¿™æ ·åšï¼‰ï¼Œæ‰€ä»¥å¦‚æœæ•°æ®å¯¹è±¡è¢«æ›¿æ¢æˆ–é‡å»ºï¼ŒåŸæ¥çš„ç¼–è¾‘å€¼å¯èƒ½ä¸¢å¤±ã€‚([ag-grid.com](https://www.ag-grid.com/javascript-data-grid/view-refresh/?utm_source=chatgpt.com "JavaScript Grid: View Refresh"))
        
6. **åˆ— autoHeight / æ¸²æŸ“é«˜åº¦é—®é¢˜**
    
    - æœ‰ issue æåˆ°ï¼šå½“ `colDef` å¯ç”¨ `autoHeight: true` æ—¶ï¼Œå¦‚æœ cell çš„å€¼æ˜¯ nullï¼undefined æˆ–ç©ºçš„æƒ…å†µä¸‹ï¼Œcell æ¸²æŸ“å™¨å¯èƒ½æ²¡æœ‰é«˜åº¦ï¼Œå¯¼è‡´æ— æ³•æ¿€æ´»ï¼Œæˆ–ç‚¹å‡»æ— æ•ˆã€‚([GitHub](https://github.com/ag-grid/ag-grid/issues/4871?utm_source=chatgpt.com "Cannot edit empty cell when colDef includes autoheight: true #4871"))
        
    - è™½ç„¶è¿™ä¸ª issueä¸»è¦æ˜¯ç©ºå€¼ç‚¹å‡»é—®é¢˜ï¼Œä¸å®Œå…¨å°±æ˜¯ â€œè¾“å…¥åæ¶ˆå¤±â€ çš„æƒ…å½¢ï¼Œä½†å¦‚æœä½ çš„åˆ—å®šä¹‰é‡Œç”¨äº† autoHeightï¼Œå€¼å¾—æ£€æŸ¥ã€‚
        
7. **ç‰ˆæœ¬ bug / å·²çŸ¥ issue**
    
    - åœ¨ GitHub issue é‡Œï¼Œæœ‰äººæåˆ° â€œFill Handle disappears after cell editingâ€ çš„é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æŸäº›ç‰ˆæœ¬æˆ–é…ç½®ä¸‹ï¼Œç¼–è¾‘æ“ä½œå¯èƒ½å¯¼è‡´æŸäº› UI å…ƒç´ ï¼ˆåŒ…æ‹¬ç¼–è¾‘å™¨ï¼‰ä¸¢å¤±ã€‚([GitHub](https://github.com/ag-grid/ag-grid/issues/3809?utm_source=chatgpt.com "Fill handle disappears from cell after edit Â· Issue #3809 Â· ag-grid/ag ..."))
        
    - æ‰€ä»¥ä½ ä¹Ÿè¦ç¡®è®¤ä½ ç”¨çš„æ˜¯å“ªä¸ªç‰ˆæœ¬çš„ ag-gridï¼Œæœ‰æ²¡æœ‰å·²çŸ¥ bugã€‚
        

---

## è°ƒè¯•å»ºè®®ï¼ˆå¾ªåºæ¸è¿›ï¼‰

ä¸‹é¢æ˜¯æˆ‘ç»™ä½ çš„ä¸€å¥—â€œé€æ­¥æŸ¥é—®é¢˜â€çš„æ“ä½œæŒ‡å—ï¼ˆåƒå®éªŒè®¾è®¡ï¼‰ï¼š

1. **æœ€ç®€å¤ç°**  
    åœ¨ä¸€ä¸ªå¹²å‡€çš„é¡µé¢ï¼Œåªå¼•å…¥ ag-gridï¼Œå»ºä¸€ä¸ªç®€å•çš„ gridï¼ˆä¸¤ä¸ªå­—æ®µã€ä¸¤ä¸ªåˆ—å®šä¹‰ï¼‰ï¼ŒæŠŠ `editable: true` éƒ½æ‰“å¼€ï¼Œä¸åšé¢å¤–é€»è¾‘ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½å¤ç°â€œè¾“å…¥ä¸¢å¤±â€çš„é—®é¢˜ã€‚  
    å¦‚æœåœ¨æœ€ç®€çš„æƒ…å†µä¸‹éƒ½æ²¡é—®é¢˜ï¼Œé‚£é—®é¢˜ä¸€å®šæ˜¯ä½ é‚£ä¸€å±‚ä¸šåŠ¡é€»è¾‘æˆ–äº¤äº’é€ æˆçš„ã€‚
    
2. **ç›‘å¬ç¼–è¾‘äº‹ä»¶ / æ‰“æ—¥å¿—**
    
    ç”¨ `onCellEditingStarted`ã€`onCellEditingStopped`ã€`onCellValueChanged` ç­‰äº‹ä»¶æ‰“æ—¥å¿—ï¼Œè§‚å¯Ÿè¾“å…¥ â†’ ç¼–è¾‘ç»“æŸ â†’ æäº¤ value çš„æµç¨‹æ˜¯å¦å®Œæ•´ã€‚  
    ç‰¹åˆ«å…³æ³¨ `cellEditingStopped` æ—¶ï¼Œparams.value / params.newValue æ˜¯ä»€ä¹ˆã€‚
    
3. **æ–­ç‚¹è°ƒè¯• / æš‚åœæ¸²æŸ“**
    
    åœ¨ä½ è¾“å…¥åï¼ˆè¿˜æ²¡æäº¤ä¹‹å‰ï¼‰æ‰“ä¸ªæ–­ç‚¹ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä»£ç ï¼ˆä¾‹å¦‚ state æ›´æ–°ã€çˆ¶ç»„ä»¶é‡æ¸²æŸ“ã€å®šæ—¶å™¨ call setRowDataï¼‰è§¦å‘ grid é‡ç»˜è¦†ç›–ã€‚
    
4. **ç¦æ­¢å¤–éƒ¨æ•°æ®è¦†ç›– / æš‚æ—¶å†»ç»“ data æ›´æ–°**
    
    ä¸´æ—¶æ³¨é‡Šæ‰ä½ æ‰€æœ‰ä¼šæ”¹ rowData æˆ–é‡æ–°ä¼  data çš„é€»è¾‘ï¼Œç¡®è®¤é‚£éƒ¨åˆ†æ˜¯å¼•å‘è¦†ç›–çš„ culpritã€‚
    
5. **æ£€æŸ¥è‡ªå®šä¹‰ç¼–è¾‘å™¨ / cellRenderer**
    
    å¦‚æœä½ ç”¨äº†è‡ªå®šä¹‰ç¼–è¾‘å™¨ï¼Œç¡®è®¤è¿™ä¸ªç¼–è¾‘å™¨çš„ `getValue()` è¿”å›æ­£ç¡®å€¼ï¼Œ`isCancelAfterEnd` é€»è¾‘æ˜¯å¦æœ‰é—®é¢˜ã€‚  
    å¦‚æœç”¨äº† cellRenderer / valueGetter / valueSetterï¼Œç¡®è®¤é€»è¾‘é‡Œæ²¡æœ‰æŠŠé”™è¯¯å€¼è¦†ç›–ã€‚
    
6. **ç‰ˆæœ¬å‡çº§ / æŸ¥ Issue**
    
    æŸ¥ä½ ç”¨çš„ ag-grid çš„ç‰ˆæœ¬ï¼Œå»çœ‹è¯¥ç‰ˆæœ¬åœ¨å…¶ GitHub Issue ä¸Šæœ‰æ²¡æœ‰ç±»ä¼¼çš„ bugï¼Œæœ‰æ²¡æœ‰ patch æˆ– workaroundã€‚
    

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ é’ˆå¯¹ä½ é‚£ä¸ªå…·ä½“é¡¹ç›®çš„ä»£ç ï¼ˆä½ å¯ä»¥è´´å‡ºåˆ—å®šä¹‰ã€ç¼–è¾‘å™¨å®šä¹‰ã€ç›¸å…³ state æ›´æ–°é€»è¾‘ç­‰ï¼‰çœ‹ä¸€çœ‹ï¼Œå¯èƒ½èƒ½ç›´æ¥æŒ‡å‡ºâ€œå“ªæ ¹çº¿è¢«å‰ªæ‰äº†â€ã€‚è¦å—ï¼Ÿ
