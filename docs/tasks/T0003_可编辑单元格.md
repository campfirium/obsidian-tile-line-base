# T0003_可编辑单元格

**状态：** 进行中
**分支：** feat/T0003-editable-cells
**积木编号：** 积木 6

## 学习目标

- 理解 `contenteditable` 属性的使用
- 掌握焦点和失焦事件处理
- 学习如何同步 DOM 和数据模型
- 处理用户输入和边界情况

## 功能描述

让表格单元格可以点击编辑，编辑后更新内存中的数据结构。

### 核心功能

1. **点击单元格进入编辑状态**
   - 单元格可点击
   - 点击后变为可编辑状态（contenteditable）
   - 自动聚焦并选中内容

2. **编辑完成保存**
   - 按 Enter 或失焦时退出编辑
   - 更新内存中的数据（H2Block 数组）
   - 不写回文件（下个积木实现）

3. **视觉反馈**
   - 编辑状态有明显的视觉标识（边框/背景色）
   - Hover 时显示可编辑提示

## 完成标准

- [ ] 点击单元格进入编辑模式
- [ ] 编辑后更新内存数据（blocks 数组）
- [ ] 按 Enter 退出编辑
- [ ] 失焦时退出编辑并保存
- [ ] 编辑状态有视觉反馈
- [ ] 控制台日志显示数据更新

## 技术要点

### 数据流

```
用户点击 → 进入编辑模式 → 用户修改 → Enter/失焦 → 更新 blocks 数组 → 不写文件
```

### 实现方案

**方案：使用 contenteditable**

优点：
- 简单直观
- 原生支持多行文本
- 与表格样式融合好

实现步骤：
1. 为 `<td>` 添加 `contenteditable="true"` 属性
2. 监听 `focus` 事件（进入编辑）
3. 监听 `blur` 事件（退出编辑并保存）
4. 监听 `keydown` 事件（按 Enter 退出）

### 数据同步

需要在 TableView 类中：
1. 保存原始 blocks 数组
2. 为每个单元格添加数据属性（行索引、列索引）
3. 编辑完成时根据索引更新对应的 block

```typescript
// 保存数据
private blocks: H2Block[] = [];
private schema: Schema | null = null;

// 单元格上添加 data 属性
td.setAttribute('data-row', String(rowIndex));
td.setAttribute('data-col', String(colIndex));

// 编辑完成时更新
onCellEdit(rowIndex: number, colIndex: number, newValue: string) {
  if (colIndex === 0) {
    // 第一列：更新标题
    this.blocks[rowIndex + 1].title = newValue;
  } else {
    // 其他列：更新段落
    this.blocks[rowIndex + 1].paragraphs[colIndex - 1] = newValue;
  }
}
```

## 边界情况

1. **空值处理**
   - 清空单元格应该保存为空字符串
   - 显示时仍然为空

2. **特殊字符**
   - 回车符应该被替换为空格或阻止（因为是单行输入）
   - Tab 键可以移到下一个单元格（可选）

3. **表头不可编辑**
   - 只有数据行（tbody）的单元格可编辑
   - 表头（thead）不可编辑

## 样式增强

```css
/* 可编辑单元格样式 */
.tlb-table td[contenteditable] {
  cursor: text;
}

.tlb-table td[contenteditable]:hover {
  background-color: var(--background-modifier-hover);
  outline: 1px solid var(--interactive-accent);
}

.tlb-table td[contenteditable]:focus {
  outline: 2px solid var(--interactive-accent);
  background-color: var(--background-primary);
}
```

## 测试步骤

1. 打开包含 H2 块的文件
2. 切换到表格视图
3. 点击任意数据单元格
4. 修改内容
5. 按 Enter 或点击其他地方
6. 打开控制台，查看 blocks 数组是否更新

## 下一步

完成后继续 T0004：写回文件功能
