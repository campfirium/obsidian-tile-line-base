# T0009_添加删除行功能

## 积木编号
**Building Block 9 / N**

## 目标
实现表格的行操作功能（添加行、删除行），为用户提供基础的数据管理能力。

## 背景
- T0008 已完成 AG Grid 集成和接口预留
- `addRow()` 和 `deleteRow()` 方法签名已预留
- 需要提供 UI 交互入口（工具栏按钮）

## 功能需求

### 1. 工具栏 UI
- 在表格上方添加工具栏区域
- 包含以下按钮：
  - **"+ 添加行"** - 在表格末尾添加新行
  - **"- 删除行"** - 删除当前选中的行（需要选中行时启用）

### 2. 添加行功能 (`addRow()`)
- **触发方式**：点击"+ 添加行"按钮
- **行为**：
  1. 在 `this.blocks` 数组末尾添加新的 H2Block
  2. 新行的 H2 标题默认为 `新条目 {N}`（N 为自动递增编号）
  3. 新行的段落数组长度与 schema 一致，初始值为空字符串
  4. 更新 AG Grid 显示
  5. 触发保存（500ms 防抖）

### 3. 删除行功能 (`deleteRow()`)
- **触发方式**：
  1. 在 AG Grid 中选中一行
  2. 点击"- 删除行"按钮
- **行为**：
  1. 从 `this.blocks` 数组中删除对应的 H2Block（注意索引偏移：blocks[rowIndex + 1]）
  2. 更新 AG Grid 显示
  3. 触发保存（500ms 防抖）
- **边界条件**：
  - 不能删除模板行（blocks[0]）
  - 至少保留 1 个数据行（可选：是否强制？）

## 技术实现

### 1. UI 结构
```typescript
// 在 render() 方法中，表格容器之前添加：
const toolbar = container.createDiv({ cls: "tlb-toolbar" });

const addRowBtn = toolbar.createEl("button", {
  text: "+ 添加行",
  cls: "tlb-btn tlb-btn-primary"
});
addRowBtn.addEventListener("click", () => this.addRow());

const deleteRowBtn = toolbar.createEl("button", {
  text: "- 删除行",
  cls: "tlb-btn tlb-btn-danger"
});
deleteRowBtn.addEventListener("click", () => {
  const selectedRows = this.gridAdapter?.getSelectedRows();
  if (selectedRows && selectedRows.length > 0) {
    this.deleteRow(selectedRows[0]);
  }
});
```

### 2. addRow() 实现
```typescript
private addRow(afterIndex?: number): void {
  if (!this.schema) return;

  // 计算新条目编号
  const entryNumber = this.blocks.length; // blocks[0] 是模板，所以长度即为下一个编号

  // 创建新 H2Block
  const newBlock: H2Block = {
    title: `新条目 ${entryNumber}`,
    paragraphs: new Array(this.schema.columnNames.length - 1).fill('')
  };

  // 添加到 blocks（末尾）
  this.blocks.push(newBlock);

  // 更新 AG Grid 显示
  const data = this.extractTableData(this.blocks, this.schema);
  this.gridAdapter?.updateData(data);

  // 触发保存
  this.scheduleSave();

  console.log(`✅ 添加新行：${newBlock.title}`);
}
```

### 3. deleteRow() 实现
```typescript
private deleteRow(rowIndex: number): void {
  if (!this.schema) return;

  // 计算 blocks 数组索引
  const blockIndex = rowIndex + 1;

  // 边界检查
  if (blockIndex <= 0 || blockIndex >= this.blocks.length) {
    console.error('Invalid row index:', rowIndex);
    return;
  }

  // 删除块
  const deletedBlock = this.blocks.splice(blockIndex, 1)[0];

  // 更新 AG Grid 显示
  const data = this.extractTableData(this.blocks, this.schema);
  this.gridAdapter?.updateData(data);

  // 触发保存
  this.scheduleSave();

  console.log(`✅ 删除行：${deletedBlock.title}`);
}
```

### 4. GridAdapter 扩展
需要在 `GridAdapter` 接口添加获取选中行的方法：
```typescript
// src/grid/GridAdapter.ts
export interface GridAdapter {
  // ... 现有方法 ...
  getSelectedRows(): number[] | null; // 返回选中行的索引数组
}
```

在 `AgGridAdapter` 中实现：
```typescript
// src/grid/AgGridAdapter.ts
getSelectedRows(): number[] | null {
  if (!this.gridApi) return null;

  const selectedNodes = this.gridApi.getSelectedNodes();
  return selectedNodes.map(node => node.rowIndex).filter(idx => idx !== null) as number[];
}
```

### 5. CSS 样式
```css
/* styles.css */
.tlb-toolbar {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  padding: 8px;
  background: var(--background-secondary);
  border-radius: 4px;
}

.tlb-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: opacity 0.2s;
}

.tlb-btn:hover {
  opacity: 0.8;
}

.tlb-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.tlb-btn-primary {
  background: var(--interactive-accent);
  color: var(--text-on-accent);
}

.tlb-btn-danger {
  background: var(--text-error);
  color: white;
}
```

## 测试计划

### 1. 添加行测试
- [ ] 点击"+ 添加行"按钮，表格末尾出现新行
- [ ] 新行的第一列显示"新条目 N"
- [ ] 新行的其他列为空
- [ ] 编辑新行的单元格，数据正常保存
- [ ] 重新打开文件，新行数据正确显示

### 2. 删除行测试
- [ ] 选中一行，点击"- 删除行"，该行被删除
- [ ] 删除行后，文件内容正确更新（对应 H2 块被删除）
- [ ] 删除第一个数据行，后续行索引正确
- [ ] 不选中任何行时，"- 删除行"按钮不可用或无效果

### 3. 边界测试
- [ ] 连续添加多行，编号正确递增
- [ ] 删除所有数据行后的行为（是否允许？）
- [ ] 添加行后立即删除，文件状态正确

### 4. 集成测试
- [ ] 添加行 → 编辑 → 保存 → 重新打开，数据完整
- [ ] 删除行 → 保存 → 重新打开，数据正确
- [ ] 深色/浅色主题下工具栏样式正确

## 验收标准
1. ✅ 工具栏 UI 显示正常，按钮样式符合 Obsidian 主题
2. ✅ 添加行功能正常，新行数据结构正确
3. ✅ 删除行功能正常，数据同步到文件
4. ✅ 所有测试用例通过
5. ✅ 代码符合现有架构（适配器模式 + blocks 数组管理）
6. ✅ 500ms 防抖保存正常工作

## 后续扩展（T0010+）
- 在指定位置插入行（支持 `afterIndex` 参数）
- 复制行功能（`duplicateRow()`）
- 批量删除多行
- 撤销/重做功能

## 依赖
- 依赖：T0008（AG Grid 集成）
- 被依赖：T0010（列操作功能）

---

**预计工作量**：2-3 小时
**优先级**：高（基础 CRUD 操作）
