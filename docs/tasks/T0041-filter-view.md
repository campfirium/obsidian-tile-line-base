# T0041-filter-view

## 任务目标

为 TileLineBase 新增“过滤视图”能力：用户可以为特定筛选条件创建标签（Filter View），选择标签时表格仅展示符合条件的记录，实现聚焦查看。

## 功能边界

- 暂不实现复杂的多视图并排展示，聚焦单个表格。
- 支持保存/切换多个视图标签，每个标签至少包含列过滤条件，后续可扩展排序、分组。
- 当未选择任何标签时，表格显示全部数据。

## 技术方案讨论

### 方案 A：充分利用 AG Grid 过滤模型（推荐）

1. **过滤模型存储**：
   - 使用 `gridApi.getFilterModel()` / `gridApi.setFilterModel(filterModel)` 读写当前过滤状态。
   - 以 JSON 存储每个标签的过滤模型，保存到插件设置或文档头部配置块。

2. **视图标签切换**：
   - 维护一个“当前视图 ID”，切换时调用 `setFilterModel(savedModel)` 并 `gridApi.onFilterChanged()`。
   - 切换后更新 UI 高亮，并在无数据时给出提示。

3. **创建/编辑流程**：
   - 用户调整列过滤 → 点击“保存为视图” → 输入标签名，写入配置。
   - 编辑/删除视图直接操作配置并刷新标签列表。

4. **优势**：复用 AG Grid 过滤能力（文本、日期、枚举等），无需自己计算数据集；官方 API 稳定。

5. **不足**：
   - 标签仅适用于现有列结构，若列被隐藏/重命名需做兼容处理。
   - 复杂逻辑（聚合、跨列自定义条件）需额外扩展。

### 方案 B：自定义过滤管线

1. 在 `TableView` 层保存所有行数据，标签切换时自行过滤后再重新 `setRowData`。
2. 需实现字段解析、比较运算、空值处理；同时配合 AG Grid 的行选择、状态列逻辑，维护成本高。
3. 适合作为方案 A 的兜底逻辑，仅在 AG Grid 不支持的特殊筛选条件下使用。

### 综合建议

- 主线使用方案 A：
  - 结合 `gridApi.setFilterModel` 与 `gridApi.setQuickFilter` 实现多列条件过滤。
  - 对于排序、列显隐等扩展条件，可进一步保存 `columnApi.getColumnState()`。
- 自定义逻辑仅在需要交叉过滤（例如基于 Markdown 原始文本）时补充。

## 数据结构草案

```json
{
  "filterViews": [
    {
      "id": "in-progress",
      "name": "进行中",
      "filterModel": {
        "status": {
          "filterType": "text",
          "type": "equals",
          "filter": "doing"
        }
      },
      "columnState": null
    }
  ],
  "activeViewId": null
}
```

- `filterModel` 完全交给 AG Grid；
- `columnState` 可选，用于保留视图内的列顺序/隐藏状态；
- 数据存放位置：插件设置文件或文档头部配置块。

## 开发任务拆分

1. **UI 与状态管理**
   - [x] 在表格上方增加“视图标签”栏（类似 Tab）。
   - [x] 支持新增、重命名、删除标签。
   - [x] 点击标签时应用对应过滤模型。

2. **过滤模型持久化**
   - [x] 接入插件设置存储，监听标签变化写回。
   - [ ] 列结构变化时校验并修复模型（去除不存在的列）。

3. **回退策略**
   - [x] 若模型为空或列不存在，自动回退至“默认视图”（显示全部）。

4. **扩展预留**
   - [ ] 预留保存排序、列宽、隐藏列等字段，方便后续实现“视图 = 过滤 + 布局”。

## 开放问题

- 标签 UI 风格：使用 Obsidian 默认标签样式或自定义？
- 过滤视图是否需要同步到 Markdown 配置块，方便跨设备共享？
- 是否允许视图间共享/覆盖（例如“默认视图”不可删除）？
