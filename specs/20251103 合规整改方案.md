# T0132 合规整改方案

## 背景
- 任务编号：T0132（合规方案）
- 目标：对照官方 Submission requirements 与《Obsidian 插件审核与打包规范（综合版）》梳理当前发布流程的合规缺口并完成整改。
- 影响范围：决定插件进入社区插件库的成功率，关联交付效率、团队信誉和用户安全体验。

## 参考基线
- **体积限制**：发布包（`main.js`、`manifest.json`、`styles.css`）必须小于 2 MB，建议控制在 500 KB 内。
- **安全条款**：禁止动态代码加载；移动端禁用 Node/Electron API；严禁收集或上报用户数据。
- **版本规范**：依赖需使用固定版本；版本号遵循 SemVer 并同步更新 `manifest.json` 与 `versions.json`；`author` 字段需可追溯。
- **目录要求**：发布包仅包含必要文件；部署脚本避免硬编码；构建流程具备可重复性。

## 现状诊断摘要
1. `dist/main.js` 曾超过 2 MB，触发审核硬限制。
2. 构建目录混入 `.hotreload`、`data.json` 等调试文件，部署脚本全量复制导致发布包超规。
3. 依赖使用 `^`/`latest`，`author` 信息为空或为占位符，违反元数据规范。
4. 构建目标仅为 ES2018，不符官方推荐（ES2020 起）。
5. 部署脚本硬编码个人 Vault 路径，阻碍团队共享与 CI 复用。
6. 缺少 `version-bump.mjs` 与 `versions.json`，无法保证版本同步。

## 整改方案执行情况
| 问题 | 主要措施 | 优先级 | 状态 | 负责人 | 预期完成 |
| --- | --- | --- | --- | --- | --- |
| 构建体积超标 | 清理 `dist`、启用生产压缩（`minify`、`legalComments: "none"`）、目标提升至 `es2020`，主包压至 ~1.34 MB | P0 | 已完成（2025-11-03） | TBD | 2025-11-07 |
| 发布包混入多余文件 | 生产构建前清空 `dist`，部署脚本改为白名单复制 `main.js`/`styles.css`/`manifest.json` | P0 | 已完成（2025-11-03） | TBD | 2025-11-05 |
| 依赖/作者信息不合规 | 固定依赖版本，补全 `package.json.author`、`manifest.json.author`/`authorUrl` | P0 | 已完成（2025-11-03） | TBD | 2025-11-04 |
| 构建目标偏低 | `esbuild` 目标改为 `es2020` 并验证桌面端运行 | P1 | 已完成（2025-11-03） | TBD | 2025-11-06 |
| 部署脚本硬编码 | 本地调试脚本保留固定路径，不随发布包分发；通过发布检查脚本确保提交产物合规 | P1 | 已完成（2025-11-03） | TBD | 2025-11-08 |
| 版本同步脚本缺失 | 新增 `version-bump.mjs`，同步维护 `package.json`、`manifest.json`、`versions.json` | P0 | 已完成（2025-11-03） | TBD | 2025-11-04 |
| CI 合规检查 | 体积、文件白名单、lint 需在 CI 执行；构建元数据需归档 | P1 | 进行中（已提供 `npm run check:release`，待接入 CI） | TBD | 2025-11-15 |
| 体积持续优化 | 识别 `ag-grid-community` 实际用量，按需打包且确保功能等价 | P1 | 进行中 | TBD | 2025-11-14 |

## 支撑动作
- `npm run check:release` 校验 dist 布局、包体积、版本同步与依赖锁定，可直接纳入 CI。
- 构建后记录 `dist/main.js` 与 `styles.css` 体积，持续跟踪趋势（当前约 1.34 MB / 81 KB）。
- 保持本地部署脚本仅用于调试，提交前依赖 `npm run check:release` 等流程校验发布包。
- 后续在 `docs/tasks/T0132_compliance-plan` 跟踪 CI 集成、体积分析、手工验证等子任务。
- 计划使用 `esbuild --metafile` + 可视化工具分析 `ag-grid` 依赖占比，为裁剪提供依据。
- 发布前的手工回归覆盖桌面端视图切换、H2 解析、增行、删除等关键交互。

## 风险与待确认
- `ag-grid-community` 必须保持现有功能；优化方案需在不影响表格行为的前提下实施。
- 若未来迭代导致包体接近 2 MB，需要预案（懒加载、模块拆分、资源压缩）。
- `versions.json` 仅记录自 0.1.0 起的版本，如需补齐历史需确认外部发布记录。
- CI 环境设置 `OBSIDIAN_PLUGIN_DIR` 的方案仍待确定，需与运维沟通并形成文档。

---

> 文档作者：TBD  
> 最近更新：2025-11-03
