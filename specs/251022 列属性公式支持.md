## 场景概述
- 任务：在列配置块中允许通过 `formula` 定义基础计算列，采用 `{字段名}` 引用现有列值。
- 范围：公式列仅参与前端渲染，不写回 Markdown 源文件。
- 前提：列字段和行数据均以字符串形式存在，现阶段未区分类型。

## 配置与数据结构调整
- `ColumnConfig` 的 `formula` 字段沿用现有解析；渲染时根据配置生成公式列清单。
- 每个公式列在运行时映射为内部字段 `__formula__<列名>`，Grid 展示层通过 `valueGetter` 读取该字段。
- 公式列默认 `editable: false`，避免用户直接修改计算结果。

## 公式语法约束
- 使用花括号引用字段：`{points} - {cost}`。
- 支持的运算符：`+ - * /` 与括号；忽略空格；暂不提供函数或比较逻辑。
- 字段缺失或值为空时视为数值 `0`；出现非数值字符时尝试解析为浮点，失败则视为 `0`。

## 解析与求值流程
1. 渲染前，从列配置中收集 `formula` 字段，解析出依赖集合并缓存。
2. 对每行数据执行：
   - 若行数超过 5000，跳过所有公式列计算并记录日志。
   - 将公式字符串替换为逆波兰表达式（Shunting Yard），仅允许白名单符号。
   - 依据当前行数据将 `{字段}` 解析为基础值，运行求值栈得到结果。
   - 计算失败时写入 `#ERR`，同时在日志输出原公式与异常原因。
3. 记下每个公式列对字段的依赖映射，以便后续重算。

## 交互入口
- 列头右键菜单提供“编辑列”，可切换列类型（文本/公式）并编辑 `formula` 字段。
- 设为公式后，该列在网格中只读；恢复为文本会移除公式配置，保留其他宽度/单位属性。

## 重算触发策略
- 监听 `cellValueChanged` 事件（现有 onCellEdit 流程），对受影响行的公式列重算。
- 判断影响范围：若编辑字段出现在某个公式列的依赖列表，则重算该列；否则跳过。
- 重算完成后写回缓存的 `RowData` 并触发 `refreshGridData()`，确保 Grid 与数据源保持一致。

## UI 与反馈
- 公式单元格展示计算结果；错误时显示 `#ERR`，鼠标悬浮展示“公式错误：{原公式}”。
- 首次加载若命中行数上限，显示一次 Notice 提示公式列被禁用。

## 后续留意
- 未来若引入字符串或日期函数，需要扩展语法及类型系统。
- 若出现性能瓶颈，可引入脏标记策略或缓存解析后的逆波兰表达式。
