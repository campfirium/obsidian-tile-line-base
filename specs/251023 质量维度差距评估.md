# 251023 质量维度差距评估

## 背景
- 目标：对 TileLineBase 现有实现按 AGENTS 中的六个质量维度进行体检，为后续迭代提供排期依据。
- 方法：运行新增的 `npm run lint`、快速检视关键模块，并记录可量化的数据点及整改建议。

## Lint 基线（2025-10-23）
- 指令：`npm run lint`
- 结果：共 24 个问题（17 个 error，7 个 warning），当前无法通过 `--max-warnings=0` 的闸口。
- 主要症状：
  - 未使用的导入与变量（例如 `src/main.ts:1` 的 `App`、`src/grid/AgGridAdapter.ts:38-39` 的状态帮助函数）。
  - `@typescript-eslint/no-inferrable-types` 在多个适配器中触发（`src/grid/AgGridAdapter.ts:83`、`src/grid/editors/TextCellEditor.ts:28`）。
  - 多处空函数/空方法是占位实现（`src/table-view/filter/FilterViewModals.ts:300`、`src/table-view/ColumnInteractionController.ts:110`）。
  - `@typescript-eslint/no-non-null-assertion` 触发 7 次，集中在公式引擎和渲染器中，提示需要显式的空值处理策略。

## Complexity
- `src/grid/AgGridAdapter.ts` 长达 1691 行，集成列定义、事件、状态逻辑，远超推荐的单文件负载；后续需要拆分成列配置、事件桥接、适配层等子模块。
- `TableView` 主类 102 行虽符合 200 行目标，但其余控制器仍有职责交叉，例如 `GridController` 同时负责事件与布局。
- 多个空方法用于占位（如 `ColumnInteractionController.onCancel`），应给出明确实现或折返到调用方，避免复杂度被隐藏。

## i18n
- 大部分核心交互已通过 `t()` 获取文案，但仍存在硬编码字符串，例如 `src/table-view/ColumnEditorModal.ts:76` 的公式占位符 `'{points} + {cost}'`、`src/renderers/StatusCellRenderer.ts` 内的状态枚举逻辑。
- `TranslationKey` 类型在 `src/formula/FormulaEngine.ts` 中导入未使用，被 lint 标记为问题，需要审查现有字典是否覆盖全部提示信息。
- 建议：梳理 `src/` 中硬编码字符串（尤其是 AG Grid 菜单、自定义提示），补充到 `src/locales/*.json` 并在 PR 中标注翻译缺口。

## a11y
- `StatusCellRenderer` 已补充 `aria-label` 与 `role=button`，但上下文菜单与键盘交互依旧依赖鼠标事件（`src/renderers/StatusCellRenderer.ts:127-168`），缺少键盘切换路径。
- `ColumnEditorModal` 依赖 Obsidian `Setting` 组件，未设置初始焦点与按 `Esc` 关闭的提示，需要验证屏幕阅读器是否能朗读字段标签。
- AG Grid 默认并不为自定义单元格提供键盘行为，需要检查 `AgGridAdapter` 中的编辑器与渲染器是否落实 `tabIndex` 与键盘事件代理。

## Security
- 目前唯一的 `innerHTML` 使用在 `StatusCellRenderer` 中清空 DOM（`src/renderers/StatusCellRenderer.ts:140`），本身安全，但需要确保后续渲染依然通过 `setIcon` 等受控 API。
- Markdown 解析链路主要集中在 `src/table-view/MarkdownBlockParser.ts`，需确认所有外部输入都途经此模块，特别是后续计划接入的公式或视图筛选。
- 建议：为解析器与渲染器补充单元注释，说明输入来源与消毒策略，并记录任何新增第三方依赖的安全评估。

## Testability
- 解析与数据层与 UI 耦合较重，例如 `AgGridAdapter` 同时处理 Obsidian 事件、持久化与 AG Grid 细节，难以在无 UI 环境下验证。
- `TableDataStore` 与 `TableViewRenderer` 之间缺少明确接口，导致手动测试成为主流；建议提炼接口，便于将来编写最小化的集成测试或脚本化验证。
- Lint 暂未覆盖测试文件（项目亦无自动测试），需要在差距整改中确定优先级。

## Performance
- 关键路径（如 `TableDataStore` 的公式重算、`AgGridAdapter` 的事件注册）未见显式的批处理或节流；在 10k 行场景下可能产生 UI 阻塞。
- 缺少性能日志或基准记录；`AGENTS.md` 中提到的 10k 行评估尚未有对应数据。
- 建议：列出高复杂度操作的热点（公式引擎、筛选、列宽计算），通过 `console.time` 或临时指标收集实际耗时，并在 `specs/` 追加基准文档。

## 后续行动建议
- 制定 lint 修复清单，优先解决未使用导入、空函数与非空断言，确保 `npm run lint` 可通过。
- 根据复杂度与可测试性结论，规划 `AgGridAdapter` 拆分方案并记录在新的 `specs/` 文档中。
- 对 i18n 与 a11y 的差距逐条建任务，结合 UI 验证流程补充复现步骤与测试样例。
