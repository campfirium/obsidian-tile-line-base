# 251025 快捷键逻辑回归分析

## 背景
- 任务编号：T0059（AgGrid 适配器拆分）  
- 关注问题：Phase 3 拆分 `AgGridInteractionController` 后，Enter / Tab / 方向键等快捷键在 Obsidian 中失效。
- 依据材料：`git show ecb91d9^:src/grid/AgGridAdapter.ts`（拆分前实现）、当前 `src/grid/AgGridAdapter.ts` 与 `src/grid/interactions/AgGridInteractionController.ts`。

## 拆分前实现（AgGridAdapter 内部）
1. **焦点追踪**  
   - `handleCellFocused` 记录 `focusedRowIndex`/`focusedColId`，随后调用 `armProxyForCurrentCell` 悬挂 `CompositionProxy`。  
   - `CompositionProxy.captureOnceAt` 将真实按键事件传递给回调 `handleProxyKeyDown`。
2. **键盘导航**  
   - `handleProxyKeyDown` 拦截 Enter / Shift+Enter → `handleProxyEnter`；Tab / Shift+Tab 与方向键调用 `moveFocus`，内部通过 `gridApi.ensureIndexVisible` 与 `setFocusedCell` 保持滚动与聚焦；Delete/Backspace 走 `handleDeleteKey` 清空单元格。  
   - 回调结束后重新 `armProxyForCurrentCell`，确保代理持续生效。
3. **最后一行 Enter**  
   - `handleEnterAtLastRow` 同时挂在 `onCellKeyDown` 与 `defaultColDef.suppressKeyboardEvent`，综合编辑状态、聚焦单元格、`focusedRowIndex` 判定是否触发 `enterAtLastRowCallback`，并使用 `pendingEnterAtLastRow` 保护。
4. **复制逻辑**  
   - `handleCopyShortcut` 优先判断序号列（`#`）是否需要触发 `onCopyH2Section`，否则复制当前聚焦单元格文本；无论事件源自代理层还是 AG Grid 原生事件都能进入该路径。

## 现有实现（AgGridInteractionController）
1. **结构调整**  
   - 控制器通过构造函数注入 `getGridApi`、`getEnterAtLastRowCallback` 等依赖（`src/grid/interactions/AgGridInteractionController.ts:17-34`），`AgGridAdapter` 负责在挂载时装配事件回调（`src/grid/AgGridAdapter.ts:106-192`）。
2. **焦点与代理**  
   - `handleCellFocused` 与 `armProxyForCurrentCell` 的流程与旧版一致（`src/grid/interactions/AgGridInteractionController.ts:153-187`, `405-452`），继续依赖 `CompositionProxy` 捕获按键。
3. **键盘导航**  
   - `handleProxyKeyDown` 在代理层消费 Enter / Tab / 方向键 / Delete（`src/grid/interactions/AgGridInteractionController.ts:454-515`），`handleProxyEnter` 与 `moveFocus` 的实现与旧版一致（`607-703`）。
4. **最后一行 Enter**  
   - `handleGridCellKeyDown` 与 `handleSuppressKeyboardEvent` 将 AG Grid 事件转发给 `handleEnterAtLastRow`（`116-150`, `706-789`），沿用旧逻辑判断是否新增行。
5. **复制逻辑差异**  
   - `handleCopyShortcut` 仅在 `CellKeyDownEvent` 分支判断序号列并触发 `onCopyH2Section`（`517-536`）；通过 `CompositionProxy` 捕获的 `Ctrl+C` 只会落入默认文本复制路径，不再校验 `gridApi.getFocusedCell()`。

## 主要差异与风险
1. **序号列复制回归**  
   - 旧版：任何 `Ctrl+C`（代理层或原生事件）都会检查聚焦列是否为 `#` → 触发 `onCopyH2Section`。  
   - 现版：仅当 `CellKeyDownEvent` 提供列信息时才触发，代理层调用 `handleCopyShortcut(event)` 时未再检查当前聚焦单元格 → `Ctrl+C` 在代理层被拦截时只复制文本，导致段落复制失效。
2. **事件装配依赖**  
   - 拆分后所有快捷键依赖 `AgGridAdapter` 正确调用 `interaction.setContainer`、`bindViewportListeners` 与各类事件代理；若挂载顺序、容器传递或 `bindViewportListeners` 失败，会直接导致 `CompositionProxy` 未布防 → 快捷键整体失效。
3. **事件封装**  
   - `normalizeKeyboardEvent` 为所有传入事件补充 `preventDefault`/`stopPropagation`（`188-214`）。若其他模块依赖 `instanceof KeyboardEvent` 检测，将无法识别包装后的对象（目前暂无直接证据，但需注意）。

## 建议动作
1. **恢复序号列复制行为**  
   - 在 `handleCopyShortcut` 入口即读取 `gridApi.getFocusedCell()`，与旧版一致地优先判断 `#` 列，确保通过代理层捕获的 `Ctrl+C` 也能触发 `onCopyH2Section`。
2. **验证代理挂载是否成功**  
   - 在调试构建中临时加日志/断点，确认 `handleCellFocused`、`armProxyForCurrentCell`、`handleProxyKeyDown` 于实际操作时被调用，排除生命周期中断问题。
3. **保留风险记录**  
   - 若需要进一步拆分或替换网格实现，需在 Specs 中持续追踪 `CompositionProxy` 与快捷键逻辑的耦合点，避免后续迁移再次引入回归。

## 后续跟踪
- 若验证中发现 `handleProxyKeyDown` 未触发，应重点排查 `bindViewportListeners` 是否执行及 `CompositionProxy.captureOnceAt` 是否 resolve。必要时可在 `scripts/dev/verify-interaction-controller.ts` 新增快捷键回归脚本。
- 修复完成后，建议在 `docs/tasks/T0059_aggrid_refactor.md` 更新 Phase 3 验证记录，并补充 `npm run dev` 下的手动回归项（Enter / Tab / Arrow / Delete / Ctrl+C）。
